<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IROA - Intelligent Resource Optimization Agent</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🧠</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .chart-container { position: relative; height: 300px; }
    .tab-content { min-height: 400px; }
    .vm-card { transition: all 0.2s ease-in-out; }
    .vm-card:hover { transform: translateY(-2px); }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      min-width: 300px;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .loading-spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Notification System -->
    <div v-if="notification" :class="[
      'notification',
      notification.type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 
      notification.type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' :
      'bg-blue-100 border border-blue-400 text-blue-700'
    ]">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <i :data-lucide="notification.type === 'success' ? 'check-circle' : notification.type === 'error' ? 'x-circle' : 'info'" class="w-5 h-5 mr-2"></i>
          <span>{{ notification.message }}</span>
        </div>
        <button @click="notification = null" class="ml-4 text-gray-400 hover:text-gray-600">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <div class="min-h-screen bg-gray-50">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                <span class="text-white font-bold text-lg">🧠</span>
              </div>
              <div>
                <h1 class="text-2xl font-bold text-gray-900">IROA</h1>
                <p class="text-sm text-gray-500">Intelligent Resource Optimization Agent</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <!-- Comprehensive Endpoint Status -->
              <div class="flex items-center space-x-4 text-sm">
                <div class="flex items-center space-x-2">
                  <div :class="endpointStatus.api ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
                  <span :class="endpointStatus.api ? 'text-green-600' : 'text-red-600'">API</span>
                </div>
                <div class="flex items-center space-x-2">
                  <div :class="endpointStatus.prometheus ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
                  <span :class="endpointStatus.prometheus ? 'text-green-600' : 'text-red-600'">Prometheus</span>
                </div>
                <div class="flex items-center space-x-2">
                  <div :class="endpointStatus.database ? 'bg-green-500' : 'bg-red-500'" class="w-2 h-2 rounded-full"></div>
                  <span :class="endpointStatus.database ? 'text-green-600' : 'text-red-600'">Database</span>
                </div>
                <div class="flex items-center space-x-2">
                  <div :class="endpointStatus.vcenter ? 'bg-green-500' : 'bg-yellow-500'" class="w-2 h-2 rounded-full"></div>
                  <span :class="endpointStatus.vcenter ? 'text-green-600' : 'text-yellow-600'">vCenter</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Navigation Tabs -->
      <nav class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-6">
          <div class="flex space-x-8">
            <button 
              v-for="tab in tabs" 
              :key="tab.id"
              @click="setActiveTab(tab.id)"
              :class="[
                'py-4 px-2 border-b-2 font-medium text-sm transition-colors duration-200',
                activeTab === tab.id 
                  ? 'border-blue-500 text-blue-600' 
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
              ]"
            >
              <i :data-lucide="tab.icon" class="w-4 h-4 inline-block mr-2"></i>
              {{ tab.name }}
            </button>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="container mx-auto px-6 py-8">
        <!-- Overview Tab -->
        <div v-if="activeTab === 'overview'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Dashboard Overview</h2>
            <p class="text-gray-600">Monitor your virtualization infrastructure at a glance</p>
          </div>

          <!-- vCenter Infrastructure Overview -->
          <div v-if="infrastructure.summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">Total VMs</p>
                  <p class="text-2xl font-bold text-gray-900 mt-1">{{ infrastructure.summary.total_vms }}</p>
                </div>
                <div class="bg-blue-500 w-12 h-12 rounded-lg flex items-center justify-center">
                  <i data-lucide="monitor" class="w-6 h-6 text-white"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <span class="text-green-600 text-sm font-medium">{{ infrastructure.summary.running_vms }} running</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">ESXi Hosts</p>
                  <p class="text-2xl font-bold text-gray-900 mt-1">{{ infrastructure.summary.total_hosts }}</p>
                </div>
                <div class="bg-green-500 w-12 h-12 rounded-lg flex items-center justify-center">
                  <i data-lucide="server" class="w-6 h-6 text-white"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <span class="text-blue-600 text-sm font-medium">{{ infrastructure.summary.total_clusters }} clusters</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">CPU Cores</p>
                  <p class="text-2xl font-bold text-gray-900 mt-1">{{ infrastructure.summary.total_cpu_cores }}</p>
                </div>
                <div class="bg-purple-500 w-12 h-12 rounded-lg flex items-center justify-center">
                  <i data-lucide="cpu" class="w-6 h-6 text-white"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <span class="text-purple-600 text-sm font-medium">Total compute capacity</span>
              </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">Memory</p>
                  <p class="text-2xl font-bold text-gray-900 mt-1">{{ Math.round(infrastructure.summary.total_memory_gb) }}GB</p>
                </div>
                <div class="bg-orange-500 w-12 h-12 rounded-lg flex items-center justify-center">
                  <i data-lucide="memory-stick" class="w-6 h-6 text-white"></i>
                </div>
              </div>
              <div class="mt-4 flex items-center">
                <span class="text-orange-600 text-sm font-medium">Total memory capacity</span>
              </div>
            </div>
          </div>
          
          <!-- Fallback Stats Grid (when no vCenter data) -->
          <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div v-for="stat in stats" :key="stat.title" class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm font-medium text-gray-600">{{ stat.title }}</p>
                  <p class="text-2xl font-bold text-gray-900 mt-1">{{ stat.value }}</p>
                </div>
                <div :class="[stat.bgColor, 'w-12 h-12 rounded-lg flex items-center justify-center']">
                  <i :data-lucide="stat.icon" class="w-6 h-6 text-white"></i>
                </div>
              </div>
              <div v-if="stat.change !== 0" class="mt-4 flex items-center">
                <i :data-lucide="stat.change > 0 ? 'trending-up' : 'trending-down'" 
                   :class="[stat.change > 0 ? 'text-green-500' : 'text-red-500', 'w-4 h-4 mr-1']"></i>
                <span :class="[stat.change > 0 ? 'text-green-600' : 'text-red-600', 'text-sm font-medium']">
                  {{ Math.abs(stat.change) }}%
                </span>
                <span class="text-gray-500 text-sm ml-1">vs last month</span>
              </div>
            </div>
            
            <!-- No vCenter Data Message -->
            <div class="col-span-full text-center py-8 bg-yellow-50 rounded-xl border border-yellow-200">
              <i data-lucide="alert-triangle" class="w-12 h-12 mx-auto mb-2 text-yellow-500"></i>
              <h3 class="text-lg font-semibold text-yellow-800 mb-2">No vCenter Data Available</h3>
              <p class="text-yellow-700 mb-4">Connect to your vCenter server to see real infrastructure data.</p>
              <button @click="setActiveTab('administration')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors">
                Configure vCenter
              </button>
            </div>
          </div>

          <!-- Charts -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Resource Usage</h3>
              <div class="chart-container">
                <canvas id="usageChart"></canvas>
              </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">VM Distribution</h3>
              <div class="chart-container">
                <canvas id="distributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Infrastructure Tab -->
        <div v-if="activeTab === 'infrastructure'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Infrastructure</h2>
            <p class="text-gray-600">Complete vCenter infrastructure inventory and resource analysis</p>
          </div>

          <!-- Infrastructure Summary -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i data-lucide="server" class="w-5 h-5 mr-2 text-blue-500"></i>
                Infrastructure Summary
              </h3>
              <button @click="loadInfrastructure()" :disabled="loading.infrastructure" 
                      class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                <div v-if="loading.infrastructure" class="loading-spinner mr-2"></div>
                <i v-else data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                {{ loading.infrastructure ? 'Loading...' : 'Refresh Data' }}
              </button>
            </div>
            
            <div v-if="infrastructure.summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              <!-- Datacenters -->
              <div @click="showInfraDetails('datacenters')" class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-8 text-center border border-blue-200 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                <div class="text-4xl font-bold text-blue-600 mb-3">{{ infrastructure.summary.total_datacenters }}</div>
                <div class="text-lg font-semibold text-blue-700 mb-2">Datacenters</div>
                <div class="text-sm text-blue-600 mb-3">Physical locations</div>
                <div class="flex items-center justify-center text-blue-500 text-sm">
                  <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                  <span>Click for details</span>
                </div>
              </div>
              
              <!-- Clusters -->
              <div @click="showInfraDetails('clusters')" class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-8 text-center border border-green-200 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                <div class="text-4xl font-bold text-green-600 mb-3">{{ infrastructure.summary.total_clusters }}</div>
                <div class="text-lg font-semibold text-green-700 mb-2">Clusters</div>
                <div class="text-sm text-green-600 mb-3">Compute clusters</div>
                <div class="flex items-center justify-center text-green-500 text-sm">
                  <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                  <span>Click for details</span>
                </div>
              </div>
              
              <!-- ESXi Hosts -->
              <div @click="showInfraDetails('hosts')" class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-xl p-8 text-center border border-purple-200 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                <div class="text-4xl font-bold text-purple-600 mb-3">{{ infrastructure.summary.total_hosts }}</div>
                <div class="text-lg font-semibold text-purple-700 mb-2">ESXi Hosts</div>
                <div class="text-sm text-purple-600 mb-3">Physical servers</div>
                <div class="flex items-center justify-center text-purple-500 text-sm">
                  <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                  <span>Click for details</span>
                </div>
              </div>
              
              <!-- Datastores -->
              <div @click="showInfraDetails('datastores')" class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-8 text-center border border-orange-200 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                <div class="text-4xl font-bold text-orange-600 mb-3">{{ infrastructure.summary.total_datastores }}</div>
                <div class="text-lg font-semibold text-orange-700 mb-2">Datastores</div>
                <div class="text-sm text-orange-600 mb-3">Storage systems</div>
                <div class="flex items-center justify-center text-orange-500 text-sm">
                  <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                  <span>Click for details</span>
                </div>
              </div>
              
              <!-- Virtual Machines -->
              <div @click="showInfraDetails('vms')" class="bg-gradient-to-r from-red-50 to-red-100 rounded-xl p-8 text-center border border-red-200 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                <div class="text-4xl font-bold text-red-600 mb-3">{{ infrastructure.summary.total_vms }}</div>
                <div class="text-lg font-semibold text-red-700 mb-2">Virtual Machines</div>
                <div class="text-sm text-red-600 mb-3">{{ infrastructure.summary.running_vms }} running</div>
                <div class="flex items-center justify-center text-red-500 text-sm">
                  <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                  <span>Click for details</span>
                </div>
              </div>
              
              <!-- Resource Summary -->
              <div @click="showInfraDetails('resources')" class="bg-gradient-to-r from-indigo-50 to-indigo-100 rounded-xl p-8 text-center border border-indigo-200 cursor-pointer hover:shadow-lg hover:scale-105 transition-all duration-200">
                <div class="text-2xl font-bold text-indigo-600 mb-2">{{ infrastructure.summary.total_cpu_cores }} Cores</div>
                <div class="text-2xl font-bold text-indigo-600 mb-3">{{ Math.round(infrastructure.summary.total_memory_gb) }}GB RAM</div>
                <div class="text-lg font-semibold text-indigo-700 mb-2">Total Resources</div>
                <div class="text-sm text-indigo-600 mb-3">Compute capacity</div>
                <div class="flex items-center justify-center text-indigo-500 text-sm">
                  <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                  <span>Click for details</span>
                </div>
              </div>
            </div>
            
            <div v-else class="text-center py-8 text-gray-500">
              <i data-lucide="database" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i>
              <p>No infrastructure data available. Please sync your vCenter first.</p>
            </div>
          </div>

          <!-- Infrastructure Details -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Clusters -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i data-lucide="layers" class="w-5 h-5 mr-2 text-green-500"></i>
                Compute Clusters ({{ infrastructure.clusters?.length || 0 }})
              </h3>
              <div v-if="infrastructure.clusters && infrastructure.clusters.length > 0" class="space-y-3 max-h-64 overflow-y-auto">
                <div v-for="cluster in infrastructure.clusters" :key="cluster.name" 
                     class="p-3 bg-gray-50 rounded-lg border">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <h4 class="font-medium text-gray-900">{{ cluster.name }}</h4>
                      <p class="text-sm text-gray-500">{{ cluster.datacenter }}</p>
                    </div>
                    <div class="text-right">
                      <div class="text-sm font-medium text-blue-600">{{ cluster.num_vms }} VMs</div>
                      <div class="text-xs text-gray-500">{{ cluster.num_hosts }} hosts</div>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>
                      <span class="text-gray-600">CPU:</span> {{ cluster.total_cpu_cores }} cores
                    </div>
                    <div>
                      <span class="text-gray-600">Memory:</span> {{ Math.round(cluster.total_memory_gb) }}GB
                    </div>
                    <div>
                      <span class="text-gray-600">DRS:</span> {{ cluster.drs_enabled ? '✅' : '❌' }}
                    </div>
                    <div>
                      <span class="text-gray-600">HA:</span> {{ cluster.ha_enabled ? '✅' : '❌' }}
                    </div>
                  </div>
                </div>
              </div>
              <div v-else class="text-center py-4 text-gray-500">
                <i data-lucide="layers" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                <p>No cluster data available</p>
              </div>
            </div>

            <!-- Hosts -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i data-lucide="monitor" class="w-5 h-5 mr-2 text-purple-500"></i>
                ESXi Hosts ({{ infrastructure.hosts?.length || 0 }})
              </h3>
              <div v-if="infrastructure.hosts && infrastructure.hosts.length > 0" class="space-y-3 max-h-64 overflow-y-auto">
                <div v-for="host in infrastructure.hosts" :key="host.name" 
                     class="p-3 bg-gray-50 rounded-lg border">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <h4 class="font-medium text-gray-900">{{ host.name }}</h4>
                      <p class="text-sm text-gray-500">{{ host.cluster }}</p>
                    </div>
                    <div class="text-right">
                      <div class="text-sm font-medium text-purple-600">{{ host.num_vms }} VMs</div>
                      <div class="text-xs" :class="host.power_state === 'poweredOn' ? 'text-green-500' : 'text-red-500'">
                        {{ host.power_state }}
                      </div>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>
                      <span class="text-gray-600">CPU:</span> {{ host.cpu_cores }} cores
                    </div>
                    <div>
                      <span class="text-gray-600">Memory:</span> {{ Math.round(host.memory_gb) }}GB
                    </div>
                    <div>
                      <span class="text-gray-600">Vendor:</span> {{ host.vendor }}
                    </div>
                    <div>
                      <span class="text-gray-600">Model:</span> {{ host.model }}
                    </div>
                  </div>
                </div>
              </div>
              <div v-else class="text-center py-4 text-gray-500">
                <i data-lucide="monitor" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                <p>No host data available</p>
              </div>
            </div>

            <!-- Datastores -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i data-lucide="hard-drive" class="w-5 h-5 mr-2 text-orange-500"></i>
                Datastores ({{ infrastructure.datastores?.length || 0 }})
              </h3>
              <div v-if="infrastructure.datastores && infrastructure.datastores.length > 0" class="space-y-3 max-h-64 overflow-y-auto">
                <div v-for="datastore in infrastructure.datastores" :key="datastore.name" 
                     class="p-3 bg-gray-50 rounded-lg border">
                  <div class="flex justify-between items-start mb-2">
                    <div>
                      <h4 class="font-medium text-gray-900">{{ datastore.name }}</h4>
                      <p class="text-sm text-gray-500">{{ datastore.type }}</p>
                    </div>
                    <div class="text-right">
                      <div class="text-sm font-medium text-orange-600">{{ datastore.usage_percent }}%</div>
                      <div class="text-xs text-gray-500">{{ datastore.num_vms }} VMs</div>
                    </div>
                  </div>
                  <div class="mb-2">
                    <div class="flex justify-between text-xs mb-1">
                      <span>Storage Usage</span>
                      <span>{{ Math.round(datastore.used_space_gb) }}GB / {{ Math.round(datastore.capacity_gb) }}GB</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                      <div class="bg-orange-500 h-2 rounded-full" :style="{width: datastore.usage_percent + '%'}"></div>
                    </div>
                  </div>
                  <div class="text-xs text-gray-600">
                    Free: {{ Math.round(datastore.free_space_gb) }}GB
                  </div>
                </div>
              </div>
              <div v-else class="text-center py-4 text-gray-500">
                <i data-lucide="hard-drive" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                <p>No datastore data available</p>
              </div>
            </div>

            <!-- Networks -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i data-lucide="network" class="w-5 h-5 mr-2 text-teal-500"></i>
                Networks ({{ infrastructure.networks?.length || 0 }})
              </h3>
              <div v-if="infrastructure.networks && infrastructure.networks.length > 0" class="space-y-3 max-h-64 overflow-y-auto">
                <div v-for="network in infrastructure.networks" :key="network.name" 
                     class="p-3 bg-gray-50 rounded-lg border">
                  <div class="flex justify-between items-center">
                    <div>
                      <h4 class="font-medium text-gray-900">{{ network.name }}</h4>
                    </div>
                    <div class="text-right">
                      <div class="text-sm font-medium text-teal-600">{{ network.num_vms }} VMs</div>
                      <div class="text-xs" :class="network.accessible ? 'text-green-500' : 'text-red-500'">
                        {{ network.accessible ? 'Accessible' : 'Inaccessible' }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div v-else class="text-center py-4 text-gray-500">
                <i data-lucide="network" class="w-8 h-8 mx-auto mb-2 text-gray-300"></i>
                <p>No network data available</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Capacity Planner Tab -->
        <div v-if="activeTab === 'capacity'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Capacity Planner</h2>
            <p class="text-gray-600">Analyze infrastructure capacity and plan for future growth</p>
          </div>

          <!-- Cluster Selection -->
          <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <label class="text-sm font-medium text-gray-700">View Capacity By:</label>
                  <select v-model="capacityView" @change="loadCapacityData" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="overall">Overall Infrastructure</option>
                    <option value="cluster">By Cluster</option>
                  </select>
                </div>
                <div v-if="capacityView === 'cluster'" class="flex items-center space-x-2">
                  <label class="text-sm font-medium text-gray-700">Select Cluster:</label>
                  <select v-model="selectedCluster" @change="loadCapacityData" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Clusters</option>
                    <option v-for="cluster in availableClusters" :key="cluster" :value="cluster">{{ cluster }}</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Capacity Overview -->
          <div v-if="capacityView === 'overall'" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Current Capacity Overview -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i data-lucide="cpu" class="w-5 h-5 mr-2 text-blue-500"></i>
                Current Infrastructure
              </h3>
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Total CPU Cores</span>
                  <span class="font-semibold">{{ capacityData.totalCPU }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Total Memory (GB)</span>
                  <span class="font-semibold">{{ Math.round(capacityData.totalMemory) }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Current VMs</span>
                  <span class="font-semibold">{{ capacityData.currentVMs }}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">CPU Utilization</span>
                  <span class="font-semibold text-orange-600">{{ Math.round(capacityData.usedCPU) }}%</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-600">Memory Utilization</span>
                  <span class="font-semibold text-orange-600">{{ Math.round(capacityData.usedMemory) }}%</span>
                </div>
              </div>
            </div>

            <!-- Capacity Recommendations -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-green-500"></i>
                Capacity Analysis
              </h3>
              <div class="space-y-4">
                <div class="bg-green-50 p-4 rounded-lg">
                  <div class="flex items-center mb-2">
                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></i>
                    <span class="font-semibold text-green-800">Additional VMs Possible</span>
                  </div>
                  <p class="text-2xl font-bold text-green-600">{{ capacityData.maxVMs - capacityData.currentVMs }}</p>
                  <p class="text-sm text-green-700 mt-1">Based on current utilization patterns</p>
                </div>
                <div class="space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Recommended VM Size</span>
                    <span class="font-medium">2 CPU / 4GB RAM</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Safety Buffer</span>
                    <span class="font-medium">20%</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Cluster Breakdown View -->
          <div v-if="capacityView === 'cluster'" class="mb-8">
            <div v-if="clusterCapacityData && clusterCapacityData.length > 0" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
              <div v-for="cluster in clusterCapacityData" :key="cluster.cluster_name" class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                  <i data-lucide="server" class="w-5 h-5 mr-2 text-blue-500"></i>
                  {{ cluster.cluster_name }}
                </h3>
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">CPU Cores</span>
                    <span class="font-semibold">{{ cluster.total_cpu_cores }}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Memory (GB)</span>
                    <span class="font-semibold">{{ Math.round(cluster.total_memory_gb) }}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Current VMs</span>
                    <span class="font-semibold">{{ cluster.current_vms }}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">CPU Usage</span>
                    <span class="font-semibold text-orange-600">{{ Math.round(cluster.cpu_utilization_percent) }}%</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Memory Usage</span>
                    <span class="font-semibold text-orange-600">{{ Math.round(cluster.memory_utilization_percent) }}%</span>
                  </div>
                  <div class="border-t pt-3 mt-3">
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-green-600">Max Additional VMs</span>
                      <span class="font-bold text-green-600">{{ cluster.max_additional_vms }}</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Limiting factor: {{ cluster.limiting_factor }}</div>
                  </div>
                </div>
              </div>
            </div>
            <div v-else class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 text-center">
              <i data-lucide="server" class="w-12 h-12 text-gray-300 mx-auto mb-4"></i>
              <h3 class="text-lg font-medium text-gray-900 mb-2">No Cluster Data Available</h3>
              <p class="text-gray-600">Please sync your vCenter infrastructure to view cluster capacity breakdown.</p>
            </div>
          </div>

          <!-- Capacity Planning Actions -->
          <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Capacity Planning Tools</h3>
            <div class="flex flex-wrap gap-4">
              <button 
                @click="loadCapacityData" 
                :disabled="loading.capacity"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center"
              >
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2" :class="{'animate-spin': loading.capacity}"></i>
                {{ loading.capacity ? 'Analyzing...' : 'Refresh Analysis' }}
              </button>
              <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                Export Report
              </button>
            </div>
          </div>

          <!-- Capacity Recommendations List -->
          <div v-if="capacityData.recommendations.length > 0" class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mt-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Optimization Recommendations</h3>
            <div class="space-y-3">
              <div v-for="rec in capacityData.recommendations" :key="rec.id" class="flex items-start p-3 bg-blue-50 rounded-lg">
                <i data-lucide="lightbulb" class="w-5 h-5 text-blue-500 mr-3 mt-0.5"></i>
                <div>
                  <p class="font-medium text-blue-900">{{ rec.title }}</p>
                  <p class="text-sm text-blue-700 mt-1">{{ rec.description }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- License Management Tab -->
        <div v-if="activeTab === 'licenses'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">License Management</h2>
            <p class="text-gray-600">Manage and track software licenses across your infrastructure</p>
          </div>

          <!-- License Actions -->
          <div class="flex justify-between items-center mb-6">
            <div class="flex gap-4">
              <button 
                @click="loadLicenses" 
                :disabled="loading.licenses"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center"
              >
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2" :class="{'animate-spin': loading.licenses}"></i>
                {{ loading.licenses ? 'Loading...' : 'Refresh Licenses' }}
              </button>
              <button 
                @click="showAddLicenseForm = true"
                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center"
              >
                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                Add License
              </button>
            </div>
            <div class="flex items-center space-x-4">
              <input 
                type="text" 
                placeholder="Search licenses..." 
                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
            </div>
          </div>

          <!-- License Cards -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" v-if="licenses.length > 0">
            <div v-for="license in licenses" :key="license.id" class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center">
                  <i data-lucide="key" class="w-6 h-6 text-blue-500 mr-3"></i>
                  <div>
                    <h3 class="font-semibold text-gray-900">{{ license.name }}</h3>
                    <p class="text-sm text-gray-600">{{ license.vendor }}</p>
                  </div>
                </div>
                <span :class="{
                  'bg-green-100 text-green-800': license.status === 'active',
                  'bg-yellow-100 text-yellow-800': license.status === 'expiring',
                  'bg-red-100 text-red-800': license.status === 'expired'
                }" class="px-2 py-1 rounded-full text-xs font-medium">
                  {{ license.status }}
                </span>
              </div>
              
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Type:</span>
                  <span class="font-medium">{{ license.type }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Used/Total:</span>
                  <span class="font-medium">{{ license.used }}/{{ license.total }}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Expires:</span>
                  <span class="font-medium">{{ license.expiryDate }}</span>
                </div>
              </div>
              
              <div class="mt-4 pt-4 border-t border-gray-100">
                <div class="flex justify-between items-center">
                  <div class="w-full bg-gray-200 rounded-full h-2 mr-3">
                    <div class="bg-blue-500 h-2 rounded-full" :style="{width: (license.used/license.total*100) + '%'}"></div>
                  </div>
                  <span class="text-xs text-gray-600 whitespace-nowrap">{{ Math.round(license.used/license.total*100) }}%</span>
                </div>
              </div>
              
              <div class="mt-4 flex gap-2">
                <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm font-medium transition-colors">
                  Edit
                </button>
                <button class="flex-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded text-sm font-medium transition-colors">
                  Details
                </button>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div v-if="licenses.length === 0 && !loading.licenses" class="text-center py-12">
            <i data-lucide="key" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No licenses found</h3>
            <p class="text-gray-600 mb-6">Add your first software license to start tracking usage and expiration dates.</p>
            <button class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center mx-auto">
              <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
              Add License
            </button>
          </div>
        </div>

        <!-- Profile Preview Tab -->
        <div v-if="activeTab === 'profiles'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Profile Preview</h2>
            <p class="text-gray-600">View VM profiles and capacity planning with 80% utilization rule</p>
          </div>

          <!-- Profile View Controls -->
          <div class="mb-6">
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <button @click="loadProfilePreview" :disabled="loading.profiles" 
                          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                    <div v-if="loading.profiles" class="loading-spinner mr-2"></div>
                    <i v-else data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                    {{ loading.profiles ? 'Loading...' : 'Refresh Profile Data' }}
                  </button>
                  <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">View By:</label>
                    <select v-model="profileView" @change="loadProfilePreview" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                      <option value="overall">Overall Infrastructure</option>
                      <option value="cluster">By Cluster</option>
                    </select>
                  </div>
                </div>
                <div v-if="profileView === 'cluster'" class="flex items-center space-x-2">
                  <label class="text-sm font-medium text-gray-700">Select Cluster:</label>
                  <select v-model="selectedProfileCluster" @change="loadProfilePreview" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Clusters</option>
                    <option v-for="cluster in availableClusters" :key="cluster" :value="cluster">{{ cluster }}</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- System Capacity Overview -->
          <div v-if="profilePreview.system_capacity" class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i data-lucide="server" class="w-5 h-5 mr-2 text-blue-500"></i>
              System Capacity (80% Rule)
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center">
                <div class="text-2xl font-bold text-blue-600">{{ profilePreview.system_capacity.total_cpu_cores }}</div>
                <div class="text-sm text-gray-500">Total CPU Cores</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-green-600">{{ profilePreview.system_capacity.total_memory_gb }}GB</div>
                <div class="text-sm text-gray-500">Total Memory</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-orange-600">{{ Math.round(profilePreview.system_capacity.cpu_utilization_percent) }}%</div>
                <div class="text-sm text-gray-500">CPU Utilization</div>
              </div>
              <div class="text-center">
                <div class="text-2xl font-bold text-red-600">{{ Math.round(profilePreview.system_capacity.memory_utilization_percent) }}%</div>
                <div class="text-sm text-gray-500">Memory Utilization</div>
              </div>
            </div>
          </div>

          <!-- Profile Analysis -->
          <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <div v-for="profile in profilePreview.profile_analysis" :key="profile.profile_id" 
                 class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{{ profile.profile_name }}</h3>
                  <p class="text-sm text-gray-500">{{ profile.cpu_per_vm }}CPU / {{ profile.memory_per_vm }}GB RAM</p>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-bold text-blue-600">{{ profile.current_count }}</div>
                  <div class="text-xs text-gray-500">Current</div>
                </div>
              </div>

              <div class="space-y-3">
                <!-- Resource Usage -->
                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span>CPU Usage</span>
                    <span>{{ profile.profile_cpu_usage_percent }}%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" :style="{width: profile.profile_cpu_usage_percent + '%'}"></div>
                  </div>
                </div>

                <div>
                  <div class="flex justify-between text-sm mb-1">
                    <span>Memory Usage</span>
                    <span>{{ profile.profile_memory_usage_percent }}%</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" :style="{width: profile.profile_memory_usage_percent + '%'}"></div>
                  </div>
                </div>

                <!-- License Status -->
                <div class="flex items-center justify-between py-2 px-3 rounded-lg" 
                     :class="profile.license_available ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'">
                  <span class="text-sm font-medium">{{ profile.license_type }}</span>
                  <div class="flex items-center">
                    <i :data-lucide="profile.license_available ? 'check-circle' : 'x-circle'" class="w-4 h-4 mr-1"></i>
                    <span class="text-xs">{{ profile.license_count_available }} available</span>
                  </div>
                </div>

                <!-- Capacity Planning -->
                <div class="border-t pt-3">
                  <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">Max Additional VMs</span>
                    <span class="text-lg font-bold text-green-600">+{{ profile.max_additional }}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-500">Total Possible</span>
                    <span class="text-sm font-semibold">{{ profile.max_total_possible }}</span>
                  </div>
                  <div class="mt-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                          :class="{
                            'bg-red-100 text-red-800': profile.limiting_factor === 'License',
                            'bg-orange-100 text-orange-800': profile.limiting_factor === 'CPU',
                            'bg-yellow-100 text-yellow-800': profile.limiting_factor === 'Memory'
                          }">
                      Limited by: {{ profile.limiting_factor }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Summary Statistics -->
          <div v-if="profilePreview.total_current_vms" class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-blue-500"></i>
              Capacity Summary
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="text-center">
                <div class="text-3xl font-bold text-blue-600">{{ profilePreview.total_current_vms }}</div>
                <div class="text-sm text-gray-600">Current VMs</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-green-600">+{{ profilePreview.total_max_additional_vms }}</div>
                <div class="text-sm text-gray-600">Additional Possible</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-bold text-purple-600">{{ profilePreview.total_current_vms + profilePreview.total_max_additional_vms }}</div>
                <div class="text-sm text-gray-600">Total Capacity</div>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div v-if="!profilePreview.profile_analysis || profilePreview.profile_analysis.length === 0" class="text-center py-12">
            <i data-lucide="layers" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No profile data available</h3>
            <p class="text-gray-600 mb-6">Click "Refresh Profile Data" to load VM profiles and capacity analysis.</p>
          </div>
        </div>

        <!-- Administration Tab -->
        <div v-if="activeTab === 'administration'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">System Administration</h2>
            <p class="text-gray-600">Manage integrations and system monitoring</p>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Integration Selection -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Available Integrations</h3>
              <div class="space-y-3">
                <div 
                  v-for="option in adminData.integrationOptions" 
                  :key="option.id"
                  @click="adminData.selectedIntegration = option.id"
                  :class="[
                    'p-4 rounded-lg border-2 cursor-pointer transition-all duration-200',
                    adminData.selectedIntegration === option.id 
                      ? 'border-blue-500 bg-blue-50' 
                      : 'border-gray-200 hover:border-gray-300'
                  ]"
                >
                  <div class="flex items-center space-x-3">
                    <span class="text-2xl">{{ option.icon }}</span>
                    <div>
                      <h4 class="font-medium text-gray-900">{{ option.name }}</h4>
                      <p class="text-sm text-gray-500">{{ option.description }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mac System Integration -->
            <div v-if="adminData.selectedIntegration === 'mac'" class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">🍎 Mac System Monitoring</h3>
              
              <!-- Mac System Controls -->
              <div class="space-y-4">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                  <div>
                    <h4 class="font-medium text-gray-900">System Monitoring</h4>
                    <p class="text-sm text-gray-500">
                      Status: {{ adminData.macMonitoring.isRunning ? 'Running' : 'Stopped' }}
                    </p>
                  </div>
                  <div class="flex space-x-2">
                    <button 
                      @click="startMacMonitoring"
                      :disabled="adminData.macMonitoring.isRunning"
                      class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Start
                    </button>
                    <button 
                      @click="stopMacMonitoring"
                      :disabled="!adminData.macMonitoring.isRunning"
                      class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Stop
                    </button>
                    <button 
                      @click="getMacStats"
                      class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                    >
                      Get Stats
                    </button>
                  </div>
                </div>

                <!-- System Info -->
                <div v-if="adminData.macMonitoring.systemInfo" class="p-4 bg-blue-50 rounded-lg">
                  <h4 class="font-medium text-gray-900 mb-2">System Information</h4>
                  <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><strong>Model:</strong> {{ adminData.macMonitoring.systemInfo.model }}</div>
                    <div><strong>CPU:</strong> {{ adminData.macMonitoring.systemInfo.cpu }}</div>
                    <div><strong>Memory:</strong> {{ adminData.macMonitoring.systemInfo.memory }}</div>
                    <div><strong>Serial:</strong> {{ adminData.macMonitoring.systemInfo.serial }}</div>
                  </div>
                </div>

                <!-- Current Stats -->
                <div v-if="adminData.macMonitoring.currentStats" class="p-4 bg-green-50 rounded-lg">
                  <h4 class="font-medium text-gray-900 mb-2">Current Statistics</h4>
                  <div class="grid grid-cols-3 gap-4 text-sm">
                    <div class="text-center">
                      <div class="text-2xl font-bold text-blue-600">{{ adminData.macMonitoring.currentStats.cpu_usage }}%</div>
                      <div class="text-gray-600">CPU Usage</div>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl font-bold text-green-600">{{ adminData.macMonitoring.currentStats.memory_usage }}%</div>
                      <div class="text-gray-600">Memory Usage</div>
                    </div>
                    <div class="text-center">
                      <div class="text-2xl font-bold text-purple-600">{{ adminData.macMonitoring.currentStats.disk_usage }}%</div>
                      <div class="text-gray-600">Disk Usage</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- VMware vCenter Integration -->
            <div v-if="adminData.selectedIntegration === 'vcenter'" class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">🏢 VMware vCenter Configuration</h3>
              <p class="text-gray-600 mb-6">Connect to your VMware vCenter Server for VM management and monitoring.</p>
              
              <div class="space-y-4">
                <div>
                  <label for="vcenter-host" class="block text-sm font-medium text-gray-700 mb-1">vCenter Host/IP</label>
                  <input id="vcenter-host" v-model="adminData.connectionForms.vcenter.host" type="text" 
                         placeholder="vcenter.company.com or 192.168.1.100"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label for="vcenter-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                  <input id="vcenter-username" 
                         v-model="adminData.connectionForms.vcenter.username" 
                         type="text" 
                         placeholder="administrator@vsphere.local"
                         autocomplete="username"
                         spellcheck="false"
                         @input="debugCredentialInput('username', $event)"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label for="vcenter-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input id="vcenter-password" 
                         v-model="adminData.connectionForms.vcenter.password" 
                         type="password" 
                         placeholder="Enter vCenter password"
                         autocomplete="current-password"
                         spellcheck="false"
                         @input="debugCredentialInput('password', $event)"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-2 flex-wrap gap-2">
                  <button @click="testConnection('vcenter')" :disabled="loading.connectionTest"
                          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                    <div v-if="loading.connectionTest" class="loading-spinner mr-2"></div>
                    <i v-else data-lucide="wifi" class="w-4 h-4 mr-2"></i>
                    {{ loading.connectionTest ? 'Testing...' : 'Test Connection' }}
                  </button>
                  <button @click="saveIntegration('vcenter')" :disabled="!isFormValid('vcenter')"
                          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                    Save Configuration
                  </button>
                  <button @click="syncVCenterVMs()" :disabled="loading.vcenterSync" 
                          class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50 flex items-center">
                    <div v-if="loading.vcenterSync" class="loading-spinner mr-2"></div>
                    <i v-else data-lucide="download" class="w-4 h-4 mr-2"></i>
                    {{ loading.vcenterSync ? 'Syncing Infrastructure...' : 'Sync Infrastructure' }}
                  </button>
                </div>
              </div>
            </div>

            <!-- Zabbix Integration -->
            <div v-if="adminData.selectedIntegration === 'zabbix'" class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">📊 Zabbix Configuration</h3>
              <p class="text-gray-600 mb-6">Connect to your Zabbix monitoring system for comprehensive infrastructure monitoring.</p>
              
              <div class="space-y-4">
                <div>
                  <label for="zabbix-url" class="block text-sm font-medium text-gray-700 mb-1">Zabbix API URL</label>
                  <input id="zabbix-url" v-model="adminData.connectionForms.zabbix.url" type="url" 
                         placeholder="http://zabbix.company.com/api_jsonrpc.php"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label for="zabbix-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                  <input id="zabbix-username" v-model="adminData.connectionForms.zabbix.username" type="text" 
                         placeholder="Admin"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label for="zabbix-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                  <input id="zabbix-password" v-model="adminData.connectionForms.zabbix.password" type="password" 
                         placeholder="Enter Zabbix password"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-2">
                  <button @click="testConnection('zabbix')" :disabled="loading.connectionTest"
                          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                    <div v-if="loading.connectionTest" class="loading-spinner mr-2"></div>
                    <i v-else data-lucide="wifi" class="w-4 h-4 mr-2"></i>
                    {{ loading.connectionTest ? 'Testing...' : 'Test Connection' }}
                  </button>
                  <button @click="saveIntegration('zabbix')" :disabled="!isFormValid('zabbix')"
                          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                    Save Configuration
                  </button>
                </div>
              </div>
            </div>

            <!-- Prometheus Integration -->
            <div v-if="adminData.selectedIntegration === 'prometheus'" class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">🔥 Prometheus Configuration</h3>
              <p class="text-gray-600 mb-6">Connect to your Prometheus server for metrics collection and monitoring.</p>
              
              <div class="space-y-4">
                <div>
                  <label for="prometheus-url" class="block text-sm font-medium text-gray-700 mb-1">Prometheus Server URL</label>
                  <input id="prometheus-url" v-model="adminData.connectionForms.prometheus.url" type="url" 
                         placeholder="http://prometheus.company.com:9090"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label for="prometheus-username" class="block text-sm font-medium text-gray-700 mb-1">Username (Optional)</label>
                  <input id="prometheus-username" v-model="adminData.connectionForms.prometheus.username" type="text" 
                         placeholder="Leave empty if no authentication"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                  <label for="prometheus-password" class="block text-sm font-medium text-gray-700 mb-1">Password (Optional)</label>
                  <input id="prometheus-password" v-model="adminData.connectionForms.prometheus.password" type="password" 
                         placeholder="Leave empty if no authentication"
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-2">
                  <button @click="testConnection('prometheus')" :disabled="loading.connectionTest"
                          class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                    <div v-if="loading.connectionTest" class="loading-spinner mr-2"></div>
                    <i v-else data-lucide="wifi" class="w-4 h-4 mr-2"></i>
                    {{ loading.connectionTest ? 'Testing...' : 'Test Connection' }}
                  </button>
                  <button @click="saveIntegration('prometheus')" :disabled="!isFormValid('prometheus')"
                          class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                    Save Configuration
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recommendations Tab -->
        <div v-if="activeTab === 'recommendations'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">AI Recommendations</h2>
            <p class="text-gray-600">Optimize your infrastructure with AI-powered insights</p>
          </div>

          <div class="mb-6">
            <button @click="loadRecommendations" :disabled="loading.recommendations" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
              <div v-if="loading.recommendations" class="loading-spinner mr-2"></div>
              <i v-else data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
              {{ loading.recommendations ? 'Loading...' : 'Refresh Recommendations' }}
            </button>
          </div>

          <div v-if="recommendations.length === 0 && !loading.recommendations" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
              <i data-lucide="info" class="w-5 h-5 text-yellow-600 mr-2"></i>
              <p class="text-yellow-800">No recommendations available. Click "Refresh Recommendations" to load data.</p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div v-for="rec in recommendations" :key="rec.vm" class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{{ rec.vm }}</h3>
                  <p class="text-sm text-gray-500">{{ rec.reason }}</p>
                </div>
                <div class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
                  Optimization
                </div>
              </div>
              <p class="text-gray-700 mb-4">{{ rec.suggestion }}</p>
              <div v-if="rec.details" class="bg-gray-50 rounded-lg p-3">
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div><strong>Avg CPU:</strong> {{ rec.details.avg_cpu }}%</div>
                  <div><strong>Avg Memory:</strong> {{ rec.details.avg_mem }}%</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Virtual Machines Tab -->
        <div v-if="activeTab === 'vms'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Virtual Machines</h2>
            <p class="text-gray-600">Monitor and manage your virtual infrastructure</p>
          </div>

          <!-- Enhanced VM Filters -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <button @click="loadUnderutilizedVMs" :disabled="loading.vms" 
                      class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                <div v-if="loading.vms" class="loading-spinner mr-2"></div>
                <i v-else data-lucide="server" class="w-4 h-4 mr-2"></i>
                {{ loading.vms ? 'Loading...' : 'Load All VMs' }}
              </button>
              <div class="text-sm text-gray-600">
                Showing {{ filteredVMs.length }} of {{ vms.length }} VMs
              </div>
            </div>
            
            <!-- Filter Controls -->
            <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Search Filter -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Search VMs</label>
                  <input v-model="vmFilters.search" type="text" placeholder="VM name, host, cluster..." 
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Status Filter -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                  <select v-model="vmFilters.status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="underutilized">Underutilized</option>
                    <option value="optimal">Optimal</option>
                    <option value="overutilized">Overutilized</option>
                    <option value="running">Running</option>
                    <option value="stopped">Stopped</option>
                  </select>
                </div>
                
                <!-- Cluster Filter -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Cluster</label>
                  <select v-model="vmFilters.cluster" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Clusters</option>
                    <option v-for="cluster in availableClusters" :key="cluster" :value="cluster">{{ cluster }}</option>
                  </select>
                </div>
                
                <!-- CPU Usage Filter -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">CPU Usage</label>
                  <select v-model="vmFilters.cpuRange" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All CPU Levels</option>
                    <option value="low">Low (< 30%)</option>
                    <option value="medium">Medium (30-70%)</option>
                    <option value="high">High (> 70%)</option>
                  </select>
                </div>
              </div>
              
              <!-- Quick Filter Buttons -->
              <div class="flex flex-wrap gap-2 mt-4">
                <button @click="applyQuickFilter('underutilized')" 
                        :class="{'bg-red-100 text-red-700 border-red-200': vmFilters.quickFilter === 'underutilized'}" 
                        class="px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">
                  <i data-lucide="trending-down" class="w-3 h-3 mr-1 inline"></i>Underutilized
                </button>
                <button @click="applyQuickFilter('overutilized')" 
                        :class="{'bg-orange-100 text-orange-700 border-orange-200': vmFilters.quickFilter === 'overutilized'}" 
                        class="px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">
                  <i data-lucide="trending-up" class="w-3 h-3 mr-1 inline"></i>Overutilized
                </button>
                <button @click="applyQuickFilter('optimal')" 
                        :class="{'bg-green-100 text-green-700 border-green-200': vmFilters.quickFilter === 'optimal'}" 
                        class="px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">
                  <i data-lucide="check-circle" class="w-3 h-3 mr-1 inline"></i>Optimal
                </button>
                <button @click="clearFilters()" class="px-3 py-1 text-sm border border-gray-300 rounded-full hover:bg-gray-50 transition-colors">
                  <i data-lucide="x" class="w-3 h-3 mr-1 inline"></i>Clear All
                </button>
              </div>
            </div>
          </div>

          <div v-if="filteredVMs.length === 0 && !loading.vms" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
              <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2"></i>
              <p class="text-blue-800">No VMs found. Click "Load Underutilized VMs" to fetch data from the API.</p>
            </div>
          </div>

          <!-- VM Cards with Enhanced Error Handling -->
          <div v-if="filteredVMs && filteredVMs.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div v-for="(vm, index) in filteredVMs" :key="`vm-${index}-${vm.vm || 'unknown'}`" class="vm-card bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{{ vm.vm || 'Unknown VM' }}</h3>
                  <div class="flex items-center space-x-2 mt-1">
                    <span class="text-xs text-gray-500">{{ vm.cluster || 'Unknown Cluster' }}</span>
                    <span class="text-xs text-gray-400">•</span>
                    <span class="text-xs text-gray-500">{{ vm.host || 'Unknown Host' }}</span>
                  </div>
                </div>
                <div :class="{
                  'bg-red-100 text-red-800': (vm.cpu || 0) < 30 && (vm.memory_usage || 0) < 50,
                  'bg-yellow-100 text-yellow-800': (vm.cpu || 0) >= 30 && (vm.cpu || 0) < 70,
                  'bg-green-100 text-green-800': (vm.cpu || 0) >= 70
                }" class="px-2 py-1 rounded-full text-xs font-medium">
                  {{ getVMStatus(vm) }}
                </div>
              </div>
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-600">CPU Usage</span>
                  <div class="flex items-center">
                    <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                      <div class="bg-blue-500 h-2 rounded-full" :style="{width: Math.min(100, Math.max(0, getCPUValue(vm))) + '%'}"></div>
                    </div>
                    <span class="text-sm font-medium">{{ Math.round(getCPUValue(vm)) }}%</span>
                  </div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-600">Memory Usage</span>
                  <div class="flex items-center">
                    <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                      <div class="bg-green-500 h-2 rounded-full" :style="{width: Math.min(100, Math.max(0, getMemoryValue(vm))) + '%'}"></div>
                    </div>
                    <span class="text-sm font-medium">{{ Math.round(getMemoryValue(vm)) }}%</span>
                  </div>
                </div>
                <div v-if="vm.details?.disk_usage" class="flex justify-between items-center">
                  <span class="text-sm text-gray-600">Disk Usage</span>
                  <div class="flex items-center">
                    <div class="w-20 bg-gray-200 rounded-full h-2 mr-2">
                      <div class="bg-purple-500 h-2 rounded-full" :style="{width: Math.min(100, Math.max(0, vm.details.disk_usage || 0)) + '%'}"></div>
                    </div>
                    <span class="text-sm font-medium">{{ Math.round(vm.details.disk_usage || 0) }}%</span>
                  </div>
                </div>
              </div>
              <div class="mt-4 pt-4 border-t border-gray-100">
                <div class="text-sm space-y-1">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Status:</span>
                    <span class="font-medium">{{ vm.status || 'Unknown' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Cores:</span>
                    <span class="font-medium">{{ vm.cores || 'N/A' }}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Memory:</span>
                    <span class="font-medium">{{ vm.memory || 'N/A' }}GB</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Source:</span>
                    <span class="font-medium capitalize">{{ vm.source || 'Unknown' }}</span>
                  </div>
                </div>
                <p v-if="vm.suggestion" class="text-sm text-gray-600 mt-2 pt-2 border-t border-gray-100">{{ vm.suggestion }}</p>
              </div>
            </div>
          </div>
          
          <!-- Loading State -->
          <div v-else-if="loading.vms" class="flex items-center justify-center py-12">
            <div class="loading-spinner mr-3"></div>
            <span class="text-gray-600">Loading virtual machines...</span>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div v-if="activeTab === 'analytics'" class="tab-content">
          <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">VMware Analytics</h2>
            <p class="text-gray-600">Historical usage data and per-cluster analytics from your VMware infrastructure</p>
          </div>

          <!-- Analytics Controls -->
          <div class="mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
              <div class="flex items-center space-x-4 flex-wrap gap-2">
                <button @click="loadClusterAnalytics()" :disabled="loading.analytics" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center">
                  <div v-if="loading.analytics" class="loading-spinner mr-2"></div>
                  <i v-else data-lucide="bar-chart-3" class="w-4 h-4 mr-2"></i>
                  {{ loading.analytics ? 'Loading...' : 'Load Cluster Analytics' }}
                </button>
                <button @click="storeHistoricalData()" :disabled="loading.storing" 
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 flex items-center">
                  <div v-if="loading.storing" class="loading-spinner mr-2"></div>
                  <i v-else data-lucide="database" class="w-4 h-4 mr-2"></i>
                  {{ loading.storing ? 'Storing...' : 'Store Current Data' }}
                </button>
                <button @click="loadHistoricalAnalytics()" :disabled="loading.historical" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50 flex items-center">
                  <div v-if="loading.historical" class="loading-spinner mr-2"></div>
                  <i v-else data-lucide="trending-up" class="w-4 h-4 mr-2"></i>
                  {{ loading.historical ? 'Loading...' : 'Load Historical Data' }}
                </button>
              </div>
              
              <!-- Time Range and Cluster Filter -->
              <div class="flex items-center space-x-3">
                <select v-model="analyticsTimeRange" @change="loadHistoricalAnalytics()" 
                        class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="24">Last 24 Hours</option>
                  <option value="168">Last 7 Days</option>
                  <option value="720">Last 30 Days</option>
                </select>
                <select v-model="selectedAnalyticsCluster" @change="loadHistoricalAnalytics()" 
                        class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">All Clusters</option>
                  <option v-for="cluster in availableAnalyticsClusters" :key="cluster" :value="cluster">
                    {{ cluster }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <!-- Cluster Analytics Overview -->
          <div v-if="clusterAnalytics && Object.keys(clusterAnalytics).length > 0" class="mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Cluster Analytics Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <div v-for="(cluster, clusterName) in clusterAnalytics" :key="clusterName" 
                   class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-4">
                  <h4 class="text-lg font-semibold text-gray-900">{{ clusterName }}</h4>
                  <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      {{ cluster.vm_count }} VMs
                    </span>
                  </div>
                </div>
                
                <div class="space-y-3">
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Running VMs</span>
                    <span class="font-medium text-green-600">{{ cluster.running_vms }}/{{ cluster.vm_count }}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">CPU Cores</span>
                    <span class="font-medium">{{ Math.round(cluster.total_cpu_cores) }}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Memory (GB)</span>
                    <span class="font-medium">{{ Math.round(cluster.total_memory_gb) }}</span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Avg CPU Usage</span>
                    <span class="font-medium" :class="cluster.avg_cpu_usage > 80 ? 'text-red-600' : cluster.avg_cpu_usage > 60 ? 'text-yellow-600' : 'text-green-600'">
                      {{ Math.round(cluster.avg_cpu_usage) }}%
                    </span>
                  </div>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Avg Memory Usage</span>
                    <span class="font-medium" :class="cluster.avg_memory_usage > 80 ? 'text-red-600' : cluster.avg_memory_usage > 60 ? 'text-yellow-600' : 'text-green-600'">
                      {{ Math.round(cluster.avg_memory_usage) }}%
                    </span>
                  </div>
                </div>
                
                <!-- CPU Usage Trend -->
                <div class="mt-4">
                  <div class="text-xs text-gray-500 mb-2">24h CPU Trend</div>
                  <div class="flex items-end space-x-1 h-8">
                    <div v-for="(point, index) in cluster.cpu_usage_trend.slice(-12)" :key="index" 
                         class="bg-blue-200 rounded-sm flex-1" 
                         :style="{height: Math.max(2, (point.value / 100) * 32) + 'px'}"
                         :title="`Hour ${point.hour}: ${Math.round(point.value)}% CPU`">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Historical Analytics -->
          <div v-if="historicalAnalytics && historicalAnalytics.length > 0" class="mb-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Historical Analytics ({{ analyticsTimeRange }}h)</h3>
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Historical Timeline -->
                <div>
                  <h4 class="text-lg font-semibold text-gray-900 mb-4">Usage Timeline</h4>
                  <div class="space-y-3">
                    <div v-for="(point, index) in historicalAnalytics.slice(-10)" :key="index" 
                         class="flex justify-between items-center py-2 border-b border-gray-100">
                      <div>
                        <div class="text-sm font-medium text-gray-900">
                          {{ new Date(point.timestamp).toLocaleString() }}
                        </div>
                        <div class="text-xs text-gray-500" v-if="selectedAnalyticsCluster">
                          Cluster: {{ selectedAnalyticsCluster }}
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-sm font-medium" v-if="selectedAnalyticsCluster && point.data">
                          CPU: {{ Math.round(point.data.avg_cpu_usage_percent) }}%
                        </div>
                        <div class="text-sm font-medium" v-else-if="!selectedAnalyticsCluster">
                          {{ point.total_vms }} VMs
                        </div>
                        <div class="text-xs text-gray-500" v-if="selectedAnalyticsCluster && point.data">
                          Memory: {{ Math.round(point.data.avg_memory_usage_percent) }}%
                        </div>
                        <div class="text-xs text-gray-500" v-else-if="!selectedAnalyticsCluster">
                          {{ Object.keys(point.clusters || {}).length }} Clusters
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Analytics Summary -->
                <div>
                  <h4 class="text-lg font-semibold text-gray-900 mb-4">Analytics Summary</h4>
                  <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                      <div class="flex items-center">
                        <i data-lucide="database" class="w-5 h-5 text-blue-600 mr-2"></i>
                        <span class="text-sm font-medium text-blue-900">Data Points</span>
                      </div>
                      <p class="text-2xl font-bold text-blue-600 mt-1">{{ historicalAnalytics.length }}</p>
                      <p class="text-xs text-blue-700">Historical records stored</p>
                    </div>
                    
                    <div class="p-4 bg-green-50 rounded-lg" v-if="availableAnalyticsClusters.length > 0">
                      <div class="flex items-center">
                        <i data-lucide="server" class="w-5 h-5 text-green-600 mr-2"></i>
                        <span class="text-sm font-medium text-green-900">Active Clusters</span>
                      </div>
                      <p class="text-2xl font-bold text-green-600 mt-1">{{ availableAnalyticsClusters.length }}</p>
                      <p class="text-xs text-green-700">Clusters being monitored</p>
                    </div>
                    
                    <div class="p-4 bg-purple-50 rounded-lg">
                      <div class="flex items-center">
                        <i data-lucide="clock" class="w-5 h-5 text-purple-600 mr-2"></i>
                        <span class="text-sm font-medium text-purple-900">Time Range</span>
                      </div>
                      <p class="text-2xl font-bold text-purple-600 mt-1">{{ analyticsTimeRange }}h</p>
                      <p class="text-xs text-purple-700">Historical data window</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div v-if="!clusterAnalytics || Object.keys(clusterAnalytics).length === 0" class="text-center py-12">
            <i data-lucide="bar-chart-3" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">No Analytics Data Available</h3>
            <p class="text-gray-600 mb-6">Load cluster analytics to view VMware infrastructure insights and historical usage data.</p>
            <button @click="loadClusterAnalytics()" :disabled="loading.analytics" 
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center mx-auto">
              <div v-if="loading.analytics" class="loading-spinner mr-2"></div>
              <i v-else data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i>
              {{ loading.analytics ? 'Loading...' : 'Load Cluster Analytics' }}
            </button>
          </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          activeTab: localStorage.getItem('iroa-active-tab') || 'overview',
          apiConnected: false,
          endpointStatus: {
            api: false,
            prometheus: false,
            database: false,
            vcenter: false
          },
          notification: null,
          notificationTimeout: null,
          vmSearchTerm: '',
          vmFilters: {
            search: '',
            status: '',
            cluster: '',
            cpuRange: '',
            quickFilter: ''
          },
          availableClusters: [],
          capacityView: 'overall',
          selectedCluster: '',
          clusterCapacityData: [],
          profileView: 'overall',
          selectedProfileCluster: '',
          recommendations: [],
          underutilizedVMs: [],
          forecast: [],
          anomalies: [],
          profiles: [],
          // Analytics data
          clusterAnalytics: {},
          historicalAnalytics: [],
          availableAnalyticsClusters: [],
          analyticsTimeRange: '24',
          selectedAnalyticsCluster: '',
          profileSummary: null,
          infrastructure: {
            datacenters: [],
            clusters: [],
            hosts: [],
            datastores: [],
            networks: [],
            summary: {
              total_datacenters: 0,
              total_clusters: 0,
              total_hosts: 0,
              total_datastores: 0,
              total_networks: 0,
              total_vms: 0,
              running_vms: 0,
              underutilized_vms: 0,
              total_cpu_cores: 0,
              total_memory_gb: 0,
              total_storage_gb: 0,
              used_storage_gb: 0
            }
          },
          capacityData: {
            totalCPU: 0,
            totalMemory: 0,
            usedCPU: 0,
            usedMemory: 0,
            maxVMs: 0,
            currentVMs: 0,
            recommendations: []
          },
          licenses: [],
          showAddLicenseForm: false,
          newLicense: {
            name: '',
            vendor: '',
            type: 'Perpetual',
            total: 1,
            used: 0,
            cost: 0,
            expiry_date: '',
            notes: ''
          },
          profilePreview: {
            system_capacity: null,
            profile_analysis: [],
            total_current_vms: 0,
            total_max_additional_vms: 0
          },
          loading: {
            recommendations: false,
            vms: false,
            analytics: false,
            anomalies: false,
            connectionTest: false,
            capacity: false,
            licenses: false,
            profiles: false,
            vcenterSync: false,
            infrastructure: false,
            storing: false,
            historical: false
          },
          apiBaseUrl: (() => {
            // Detect the correct API base URL for both local and remote server deployment
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = '8001';
            
            // Construct API base URL
            const baseUrl = `${protocol}//${hostname}:${port}`;
            
            // Debug logging
            console.log('🔗 API Base URL Configuration:');
            console.log('   Protocol:', protocol);
            console.log('   Hostname:', hostname);
            console.log('   Port:', port);
            console.log('   Full API URL:', baseUrl);
            
            return baseUrl;
          })(),
          tabs: [
            { id: 'overview', name: 'Overview', icon: 'layout-grid' },
            { id: 'recommendations', name: 'Recommendations', icon: 'lightbulb' },
            { id: 'vms', name: 'Virtual Machines', icon: 'monitor' },
            { id: 'analytics', name: 'Analytics', icon: 'bar-chart-3' },
            { id: 'infrastructure', name: 'Infrastructure', icon: 'server' },
            { id: 'capacity', name: 'Capacity Planner', icon: 'cpu' },
            { id: 'profiles', name: 'Profile Preview', icon: 'layers' },
            { id: 'licenses', name: 'License Management', icon: 'key' },
            { id: 'administration', name: 'Administration', icon: 'settings' }
          ],
          stats: [
            { title: 'Total VMs', value: '0', change: 0, icon: 'server', bgColor: 'bg-blue-500' },
            { title: 'Underutilized', value: '0', change: 0, icon: 'trending-down', bgColor: 'bg-yellow-500' },
            { title: 'Cost Savings', value: '$0', change: 0, icon: 'dollar-sign', bgColor: 'bg-green-500' },
            { title: 'Efficiency', value: '0%', change: 0, icon: 'zap', bgColor: 'bg-purple-500' }
          ],
          adminData: {
            selectedIntegration: 'mac',
            macMonitoring: {
              isRunning: false,
              interval: 30,
              lastUpdate: null,
              systemInfo: null,
              currentStats: null
            },
            integrationOptions: [
              { id: 'mac', name: 'Mac System', icon: '🍎', description: 'Monitor your Mac system resources' },
              { id: 'vcenter', name: 'VMware vCenter', icon: '🏢', description: 'Connect to VMware vCenter Server' },
              { id: 'zabbix', name: 'Zabbix', icon: '📊', description: 'Integrate with Zabbix monitoring' },
              { id: 'prometheus', name: 'Prometheus', icon: '🔥', description: 'Connect to Prometheus metrics' }
            ],
            connectionForms: {
              vcenter: { host: 'vcenter.local', username: 'administrator@vsphere.local', password: '' },
              zabbix: { url: 'http://zabbix.local', username: 'admin', password: '' },
              prometheus: { url: window.location.protocol + '//' + window.location.hostname + ':9090', username: '', password: '' }
            },
            savedIntegrations: {}
          }
        };
      },
      computed: {
        filteredVMs() {
          let vms = this.vms || this.underutilizedVMs || [];
          
          // Apply search filter
          if (this.vmFilters.search) {
            const searchTerm = this.vmFilters.search.toLowerCase();
            vms = vms.filter(vm => 
              (vm.vm || '').toLowerCase().includes(searchTerm) ||
              (vm.host || '').toLowerCase().includes(searchTerm) ||
              (vm.cluster || '').toLowerCase().includes(searchTerm)
            );
          }
          
          // Apply status filter
          if (this.vmFilters.status) {
            vms = vms.filter(vm => {
              const status = this.getVMStatus(vm).toLowerCase();
              return status.includes(this.vmFilters.status.toLowerCase());
            });
          }
          
          // Apply cluster filter
          if (this.vmFilters.cluster) {
            vms = vms.filter(vm => (vm.cluster || '') === this.vmFilters.cluster);
          }
          
          // Apply CPU range filter
          if (this.vmFilters.cpuRange) {
            vms = vms.filter(vm => {
              const cpu = this.getCPUValue(vm);
              switch (this.vmFilters.cpuRange) {
                case 'low': return cpu < 30;
                case 'medium': return cpu >= 30 && cpu <= 70;
                case 'high': return cpu > 70;
                default: return true;
              }
            });
          }
          
          return vms;
        },
        
        vms() {
          return this.underutilizedVMs;
        }
      },
      async mounted() {
        // Initialize Lucide icons
        lucide.createIcons();
        
        // Run network diagnostics for debugging
        await this.runNetworkDiagnostics();
        
        // Check API connection with error handling
        try {
          await this.checkApiConnection();
        } catch (error) {
          console.error('❌ API connection check failed:', error);
          this.apiConnected = false;
        }
        
        // Load initial data
        await this.loadSystemInfo();
        await this.checkEndpointStatus();
        await this.loadIntegrationConfig();
        
        // Load infrastructure data for Overview page
        await this.loadInfrastructure();
        
        // Load data for active tab
        if (this.activeTab === 'vms') {
          this.loadUnderutilizedVMs();
        } else if (this.activeTab === 'infrastructure') {
          this.loadInfrastructure();
        } else if (this.activeTab === 'capacity') {
          this.loadCapacityData();
        } else if (this.activeTab === 'profiles') {
          this.loadProfilePreview();
        } else if (this.activeTab === 'licenses') {
          this.loadLicenses();
        }
      },
      methods: {
        // Tab management
        setActiveTab(tab) {
          this.activeTab = tab;
          localStorage.setItem('iroa-active-tab', tab);
          
          // Load data when switching to specific tabs
          if (tab === 'vms') {
            this.loadUnderutilizedVMs();
          } else if (tab === 'analytics') {
            // Analytics data is loaded on demand
          } else if (tab === 'infrastructure') {
            this.loadInfrastructure();
          } else if (tab === 'capacity') {
            this.loadCapacityData();
          } else if (tab === 'profiles') {
            this.loadProfilePreview();
          } else if (tab === 'licenses') {
            this.loadLicenses();
          }
        },

        // Notification system with proper Vue reactivity
        showNotification(message, type = 'info') {
          // Clear any existing notification first
          if (this.notificationTimeout) {
            clearTimeout(this.notificationTimeout);
          }
          
          // Use Vue's nextTick to ensure DOM is ready
          this.$nextTick(() => {
            this.notification = { message, type };
            this.notificationTimeout = setTimeout(() => {
              this.notification = null;
              this.notificationTimeout = null;
            }, 5000);
          });
        },

        // API connectivity check with proper error handling
        async checkApiConnection() {
          try {
            console.log('🔍 Testing API connection to:', this.apiBaseUrl);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            const response = await fetch(`${this.apiBaseUrl}/health`, {
              method: 'GET',
              signal: controller.signal,
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              }
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
              console.log('✅ API connection successful');
              this.apiConnected = true;
              return true;
            } else {
              console.error('❌ API connection failed with status:', response.status, response.statusText);
              this.apiConnected = false;
              return false;
            }
          } catch (error) {
            console.error('❌ API connection error:', error);
            if (error.name === 'AbortError') {
              console.error('   ⏱️ Connection timeout - API server may be unreachable');
            } else if (error.message.includes('Failed to fetch')) {
              console.error('   🌐 Network error - check if API server is running on port 8001');
              console.error('   🔗 Expected API URL:', this.apiBaseUrl);
            }
            this.apiConnected = false;
            return false;
          }
        },

        // Network diagnostic function for troubleshooting remote server issues
        async runNetworkDiagnostics() {
          console.log('🔍 Running network diagnostics...');
          console.log('   🌐 Current URL:', window.location.href);
          console.log('   💻 Client hostname:', window.location.hostname);
          console.log('   🔗 API base URL:', this.apiBaseUrl);
          
          // Test basic connectivity
          const tests = [
            { name: 'API Health Check', url: `${this.apiBaseUrl}/health` },
            { name: 'API System Info', url: `${this.apiBaseUrl}/system/info` },
            { name: 'API VMs Endpoint', url: `${this.apiBaseUrl}/vms` }
          ];
          
          for (const test of tests) {
            try {
              console.log(`   🧪 Testing ${test.name}...`);
              const response = await fetch(test.url, { 
                method: 'GET',
                timeout: 5000,
                headers: { 'Accept': 'application/json' }
              });
              
              if (response.ok) {
                console.log(`   ✅ ${test.name}: SUCCESS (${response.status})`);
              } else {
                console.log(`   ❌ ${test.name}: FAILED (${response.status} ${response.statusText})`);
              }
            } catch (error) {
              console.log(`   ❌ ${test.name}: ERROR - ${error.message}`);
            }
          }
          
          console.log('🔍 Network diagnostics complete.');
        },

        // System information with proper error handling
        async loadSystemInfo() {
          try {
            const response = await fetch(`${this.apiBaseUrl}/system/info`);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();
            this.systemInfo = data;
            
            // Update admin integration options based on detected OS
            this.adminData.integrationOptions[0] = {
              id: data.system_type,
              name: `${data.os_config.name} System`,
              icon: data.os_config.icon,
              description: data.os_config.description
            };
            
            // Set default selection to detected OS
            this.adminData.selectedIntegration = data.system_type;
          } catch (error) {
            console.error('Failed to load system info:', error);
          }
        },

        // Recommendations methods
        async loadRecommendations() {
          this.loading.recommendations = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/recommendations`);
            const data = await response.json();
            this.recommendations = data;
            this.showNotification(`Loaded ${data.length} recommendations`, 'success');
          } catch (error) {
            this.showNotification('Failed to load recommendations: ' + error.message, 'error');
          } finally {
            this.loading.recommendations = false;
          }
        },

        // VM methods
        async loadUnderutilizedVMs() {
          console.log('🔄 Loading VMs from API...');
          this.loading.vms = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/vms`);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            
            // Validate and sanitize VM data to prevent rendering errors
            const sanitizedVMs = this.sanitizeVMData(data);
            this.underutilizedVMs = sanitizedVMs;
            
            console.log(`✅ Loaded ${sanitizedVMs.length} VMs:`, sanitizedVMs);
            
            // Update stats based on real data
            this.updateStatsFromVMs(sanitizedVMs);
            
            // Update available clusters for filtering
            this.updateAvailableClusters();
            
            const systemVM = sanitizedVMs.find(vm => vm.source === 'prometheus');
            const message = systemVM ? 
              `Found ${sanitizedVMs.length} VMs (including ${systemVM.vm} from Prometheus)` : 
              `Found ${sanitizedVMs.length} VMs`;
            this.showNotification(message, 'success');
          } catch (error) {
            console.error('❌ Failed to load VMs:', error);
            this.showNotification('Failed to load VMs: ' + error.message, 'error');
            // Set fallback data to prevent rendering errors
            this.underutilizedVMs = [];
          } finally {
            this.loading.vms = false;
          }
        },

        // Sanitize VM data to prevent Vue.js rendering errors
        sanitizeVMData(vms) {
          if (!Array.isArray(vms)) {
            console.warn('⚠️ VM data is not an array, converting:', vms);
            return [];
          }
          
          return vms.map((vm, index) => {
            // Ensure all required fields exist with safe defaults
            const sanitized = {
              vm: vm.vm || `VM-${index + 1}`,
              status: vm.status || 'unknown',
              cpu: this.safeNumber(vm.cpu, 0),
              memory_usage: this.safeNumber(vm.memory_usage, 0),
              cores: this.safeNumber(vm.cores, 0),
              memory: this.safeNumber(vm.memory, 0),
              cluster: vm.cluster || 'unknown',
              source: vm.source || 'unknown',
              suggestion: vm.suggestion || '',
              details: {
                avg_cpu: this.safeNumber(vm.details?.avg_cpu, vm.cpu || 0),
                avg_mem: this.safeNumber(vm.details?.avg_mem, vm.memory_usage || 0),
                disk_usage: this.safeNumber(vm.details?.disk_usage, 0)
              }
            };
            
            console.log(`🔧 Sanitized VM ${index + 1}:`, sanitized);
            return sanitized;
          });
        },

        // Helper method to safely convert values to numbers
        safeNumber(value, defaultValue = 0) {
          const num = parseFloat(value);
          return isNaN(num) ? defaultValue : num;
        },

        // Get CPU value with fallback
        getCPUValue(vm) {
          return this.safeNumber(vm.details?.avg_cpu || vm.cpu, 0);
        },

        // Get Memory value with fallback
        getMemoryValue(vm) {
          return this.safeNumber(vm.details?.avg_mem || vm.memory_usage, 0);
        },

        // Get VM status based on utilization
        getVMStatus(vm) {
          const cpu = this.getCPUValue(vm);
          const memory = this.getMemoryValue(vm);
          
          if (cpu < 30 && memory < 50) {
            return 'Underutilized';
          } else if (cpu >= 70 || memory >= 80) {
            return 'High Usage';
          } else {
            return 'Normal';
          }
        },

        // Update overview stats based on real VM data
        updateStatsFromVMs(vms) {
          const totalVMs = vms.length;
          const underutilizedVMs = vms.filter(vm => vm.cpu < 30 && vm.memory_usage < 50).length;
          const avgEfficiency = totalVMs > 0 ? Math.round(vms.reduce((acc, vm) => acc + vm.cpu, 0) / totalVMs) : 0;
          const costSavings = underutilizedVMs * 124; // $124 per underutilized VM
          
          this.stats[0].value = totalVMs.toString();
          this.stats[1].value = underutilizedVMs.toString();
          this.stats[2].value = `$${costSavings.toLocaleString()}`;
          this.stats[3].value = `${avgEfficiency}%`;
        },

        // Analytics methods
        async loadForecast(vmId) {
          this.loading.analytics = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/forecast/${vmId}?hours=24`);
            const data = await response.json();
            this.forecast = data.cpu_forecast || [];
            this.showNotification('CPU forecast loaded successfully', 'success');
          } catch (error) {
            this.showNotification('Failed to load forecast: ' + error.message, 'error');
          } finally {
            this.loading.analytics = false;
          }
        },

        async loadAnomalies(vmId) {
          this.loading.anomalies = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/anomalies/${vmId}`);
            const data = await response.json();
            this.anomalies = data.anomalies || [];
            this.showNotification(`Found ${this.anomalies.length} anomalies`, 'success');
          } catch (error) {
            this.showNotification('Failed to load anomalies: ' + error.message, 'error');
          } finally {
            this.loading.anomalies = false;
          }
        },

        async loadPrometheusAnalytics() {
          this.loading.analytics = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/analytics/prometheus`);
            const data = await response.json();
            
            // Update forecast with Prometheus CPU data
            this.forecast = data.cpu_history || [];
            
            // Create anomalies from memory spikes (>80% usage)
            this.anomalies = [];
            if (data.memory_history) {
              data.memory_history.forEach((memUsage, index) => {
                if (memUsage > 80) {
                  this.anomalies.push({
                    timestamp: new Date(Date.now() - (data.memory_history.length - index) * 300000).toISOString(),
                    metric: 'memory_usage',
                    value: memUsage,
                    severity: 'high',
                    description: `High memory usage: ${memUsage.toFixed(1)}%`
                  });
                }
              });
            }
            
            this.showNotification(`Loaded Mac analytics from Prometheus (${data.timeframe})`, 'success');
          } catch (error) {
            this.showNotification('Failed to load Prometheus analytics: ' + error.message, 'error');
          } finally {
            this.loading.analytics = false;
          }
        },

        // Mac monitoring methods
        async startMacMonitoring() {
          try {
            const response = await fetch(`${this.apiBaseUrl}/admin/mac/start`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ interval: this.adminData.macMonitoring.interval })
            });
            const data = await response.json();
            if (data.status === 'started') {
              this.adminData.macMonitoring.isRunning = true;
              this.showNotification('Mac monitoring started successfully!', 'success');
            }
          } catch (error) {
            this.showNotification('Failed to start Mac monitoring: ' + error.message, 'error');
          }
        },

        async stopMacMonitoring() {
          try {
            const response = await fetch(`${this.apiBaseUrl}/admin/mac/stop`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (data.status === 'stopped') {
              this.adminData.macMonitoring.isRunning = false;
              this.showNotification('Mac monitoring stopped successfully!', 'success');
            }
          } catch (error) {
            this.showNotification('Failed to stop Mac monitoring: ' + error.message, 'error');
          }
        },

        async getMacStats() {
          try {
            const response = await fetch(`${this.apiBaseUrl}/admin/mac/stats`);
            const data = await response.json();
            this.adminData.macMonitoring.systemInfo = data.system_info;
            this.adminData.macMonitoring.currentStats = {
              cpu_usage: Math.round(data.cpu_usage * 10) / 10,
              memory_usage: Math.round(data.memory_usage * 10) / 10,
              disk_usage: Math.round(data.disk_usage * 10) / 10
            };
            this.adminData.macMonitoring.isRunning = data.monitoring_active;
            this.showNotification('Mac stats updated successfully', 'success');
          } catch (error) {
            this.showNotification('Failed to get Mac stats: ' + error.message, 'error');
          }
        },

        // Enhanced VM filtering methods
        applyQuickFilter(filterType) {
          this.vmFilters.quickFilter = filterType;
          switch (filterType) {
            case 'underutilized':
              this.vmFilters.status = 'underutilized';
              this.vmFilters.cpuRange = 'low';
              break;
            case 'overutilized':
              this.vmFilters.status = 'overutilized';
              this.vmFilters.cpuRange = 'high';
              break;
            case 'optimal':
              this.vmFilters.status = 'optimal';
              this.vmFilters.cpuRange = 'medium';
              break;
          }
        },
        
        clearFilters() {
          this.vmFilters = {
            search: '',
            status: '',
            cluster: '',
            cpuRange: '',
            quickFilter: ''
          };
        },
        
        // Infrastructure deep dive methods
        showInfraDetails(type) {
          console.log(`🔍 Showing ${type} details`);
          
          // Implement real infrastructure deep dive functionality
          switch (type) {
            case 'datacenters':
              if (this.infrastructure.datacenters && this.infrastructure.datacenters.length > 0) {
                const details = this.infrastructure.datacenters.map(dc => 
                  `${dc.name || 'Unknown'} (${dc.clusters || 0} clusters, ${dc.hosts || 0} hosts)`
                ).join(', ');
                this.showNotification(`Datacenters: ${details}`, 'success');
              } else {
                this.showNotification('No datacenter information available. Please sync vCenter first.', 'warning');
              }
              break;
              
            case 'clusters':
              if (this.infrastructure.clusters && this.infrastructure.clusters.length > 0) {
                const details = this.infrastructure.clusters.map(cluster => 
                  `${cluster.name || 'Unknown'} (${cluster.hosts || 0} hosts, ${cluster.vms || 0} VMs)`
                ).join(', ');
                this.showNotification(`Clusters: ${details}`, 'success');
              } else {
                this.showNotification('No cluster information available. Please sync vCenter first.', 'warning');
              }
              break;
              
            case 'hosts':
              if (this.infrastructure.hosts && this.infrastructure.hosts.length > 0) {
                const details = this.infrastructure.hosts.map(host => 
                  `${host.name || 'Unknown'} (${Math.round(host.cpu_cores || 0)} cores, ${Math.round(host.memory_gb || 0)}GB)`
                ).join(', ');
                this.showNotification(`Hosts: ${details}`, 'success');
              } else {
                this.showNotification('No host information available. Please sync vCenter first.', 'warning');
              }
              break;
              
            case 'datastores':
              if (this.infrastructure.datastores && this.infrastructure.datastores.length > 0) {
                const details = this.infrastructure.datastores.map(ds => 
                  `${ds.name || 'Unknown'} (${Math.round(ds.capacity_gb || 0)}GB total, ${Math.round(ds.free_gb || 0)}GB free)`
                ).join(', ');
                this.showNotification(`Datastores: ${details}`, 'success');
              } else {
                this.showNotification('No datastore information available. Please sync vCenter first.', 'warning');
              }
              break;
              
            case 'vms':
              if (this.underutilizedVMs && this.underutilizedVMs.length > 0) {
                const runningVMs = this.underutilizedVMs.filter(vm => vm.status === 'running').length;
                const totalVMs = this.underutilizedVMs.length;
                const clusters = [...new Set(this.underutilizedVMs.map(vm => vm.cluster).filter(Boolean))];
                this.showNotification(`VMs: ${runningVMs}/${totalVMs} running across ${clusters.length} clusters: ${clusters.join(', ')}`, 'success');
              } else {
                this.showNotification('No VM information available. Please load VMs first.', 'warning');
              }
              break;
              
            case 'resources':
              const summary = this.infrastructure.summary;
              if (summary && (summary.total_cpu_cores > 0 || summary.total_memory_gb > 0)) {
                const resourceDetails = [
                  `CPU: ${Math.round(summary.total_cpu_cores || 0)} cores`,
                  `Memory: ${Math.round(summary.total_memory_gb || 0)}GB`,
                  `Storage: ${Math.round(summary.total_storage_gb || 0)}GB total`,
                  `Used: ${Math.round(summary.used_storage_gb || 0)}GB`
                ].join(', ');
                this.showNotification(`Resources: ${resourceDetails}`, 'success');
              } else {
                this.showNotification('No resource information available. Please sync vCenter first.', 'warning');
              }
              break;
              
            default:
              this.showNotification(`${type} details - Feature implementation in progress`, 'info');
          }
        },
        
        // Update available clusters from VM data
        updateAvailableClusters() {
          const clusters = new Set();
          if (this.underutilizedVMs) {
            this.underutilizedVMs.forEach(vm => {
              if (vm.cluster) clusters.add(vm.cluster);
            });
          }
          if (this.infrastructure.clusters) {
            this.infrastructure.clusters.forEach(cluster => {
              if (cluster.name) clusters.add(cluster.name);
            });
          }
          this.availableClusters = Array.from(clusters).sort();
        },

        // Capacity Planner methods
        async loadCapacityData() {
          this.loading.capacity = true;
          try {
            console.log(`🔄 Loading capacity data (view: ${this.capacityView}, cluster: ${this.selectedCluster})...`);
            
            if (this.capacityView === 'cluster') {
              // Load cluster breakdown data
              const response = await fetch(`${this.apiBaseUrl}/capacity/clusters`);
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              const data = await response.json();
              
              // Transform the data to match the expected format
              if (data.clusters && Array.isArray(data.clusters)) {
                this.clusterCapacityData = data.clusters.map(cluster => ({
                  cluster_name: cluster.cluster || cluster.cluster_name || 'Unknown',
                  current_vms: cluster.current_vms || 0,
                  total_cpu_cores: cluster.total_cpu_cores || 0,
                  total_memory_gb: Math.round(cluster.total_memory_gb || 0),
                  cpu_utilization_percent: Math.round(cluster.cpu_utilization || cluster.cpu_utilization_percent || 0),
                  memory_utilization_percent: Math.round(cluster.memory_utilization || cluster.memory_utilization_percent || 0),
                  max_additional_vms: cluster.max_additional_vms || 0,
                  limiting_factor: cluster.limiting_factor || 'CPU'
                }));
                
                // Update available clusters for dropdown
                this.availableClusters = this.clusterCapacityData.map(c => c.cluster_name);
                
                console.log(`✅ Loaded capacity data for ${this.clusterCapacityData.length} clusters`);
                this.showNotification(`Loaded capacity analysis for ${this.clusterCapacityData.length} clusters`, 'success');
              } else {
                console.warn('⚠️ No cluster capacity data available');
                this.clusterCapacityData = [];
                this.showNotification('No cluster capacity data available', 'warning');
              }
            } else {
              // Load overall capacity data
              const response = await fetch(`${this.apiBaseUrl}/capacity/analysis`);
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              const data = await response.json();
              
              this.capacityData = {
                totalCPU: Math.round(data.total_cpu_cores || 0),
                totalMemory: Math.round(data.total_memory_gb || 0),
                usedCPU: Math.round(data.cpu_utilization_percent || 0),
                usedMemory: Math.round(data.memory_utilization_percent || 0),
                maxVMs: data.max_additional_vms || 0,
                currentVMs: data.current_vms || 0,
                recommendations: data.recommendations || []
              };
              
              console.log('✅ Loaded overall capacity data:', this.capacityData);
              this.showNotification('Overall capacity analysis updated successfully!', 'success');
            }
          } catch (error) {
            console.error('Failed to load capacity data:', error);
            // Fallback to mock data for demonstration
            this.capacityData = {
              totalCPU: this.systemInfo?.cpu_count || 11,
              totalMemory: this.systemInfo?.memory_total_gb || 18,
              usedCPU: 45.2,
              usedMemory: 34.5,
              maxVMs: 8,
              currentVMs: 1,
              recommendations: [
                {
                  id: 1,
                  title: 'Optimize Resource Allocation',
                  description: 'Current utilization allows for 7 additional VMs with 2 CPU cores and 4GB RAM each.'
                },
                {
                  id: 2,
                  title: 'Consider Memory Upgrade',
                  description: 'Adding 16GB RAM would increase capacity to 12 additional VMs.'
                }
              ]
            };
            this.showNotification('Using estimated capacity data', 'info');
          } finally {
            this.loading.capacity = false;
          }
        },

        // Endpoint Status Checking
        async checkAllEndpoints() {
          console.log('🔍 Checking all endpoint statuses...');
          
          // Check API
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            const apiResponse = await fetch(`${this.apiBaseUrl}/health`, {
              signal: controller.signal,
              headers: { 'Accept': 'application/json' }
            });
            
            clearTimeout(timeoutId);
            this.endpointStatus.api = apiResponse.ok;
            this.apiConnected = apiResponse.ok;
            console.log(`✅ API Status: ${apiResponse.ok ? 'Connected' : 'Disconnected'}`);
          } catch (error) {
            this.endpointStatus.api = false;
            this.apiConnected = false;
            console.error('❌ API Status: Disconnected -', error.message);
          }
          
          // Check Prometheus (via API proxy to avoid CORS)
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            const prometheusResponse = await fetch(`${this.apiBaseUrl}/admin/prometheus/status`, {
              signal: controller.signal,
              headers: { 'Accept': 'application/json' }
            });
            
            clearTimeout(timeoutId);
            this.endpointStatus.prometheus = prometheusResponse.ok;
            console.log(`✅ Prometheus Status: ${prometheusResponse.ok ? 'Connected' : 'Disconnected'}`);
          } catch (error) {
            this.endpointStatus.prometheus = false;
            console.error('❌ Prometheus Status: Disconnected -', error.message);
          }
          
          // Check Database (via VMs endpoint as proxy)
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            const dbResponse = await fetch(`${this.apiBaseUrl}/vms`, {
              signal: controller.signal,
              headers: { 'Accept': 'application/json' }
            });
            
            clearTimeout(timeoutId);
            this.endpointStatus.database = dbResponse.ok;
            console.log(`✅ Database Status: ${dbResponse.ok ? 'Connected' : 'Disconnected'}`);
          } catch (error) {
            this.endpointStatus.database = false;
            console.error('❌ Database Status: Disconnected -', error.message);
          }
          
          // Check vCenter (via VMs endpoint to see if vCenter VMs are available)
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            
            const vcenterResponse = await fetch(`${this.apiBaseUrl}/vcenter/vms`, {
              signal: controller.signal,
              headers: { 'Accept': 'application/json' }
            });
            
            clearTimeout(timeoutId);
            if (vcenterResponse.ok) {
              const vms = await vcenterResponse.json();
              this.endpointStatus.vcenter = Array.isArray(vms) && vms.length > 0;
            } else {
              this.endpointStatus.vcenter = false;
            }
            console.log(`✅ vCenter Status: ${this.endpointStatus.vcenter ? 'Connected with VMs' : 'Not Connected'}`);
          } catch (error) {
            this.endpointStatus.vcenter = false;
            console.error('❌ vCenter Status: Not Connected -', error.message);
          }
        },

        // License Management methods
        async loadLicenses() {
          console.log('📄 Loading licenses...');
          this.loading.licenses = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/licenses`);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();
            this.licenses = data;
            console.log('✅ Licenses loaded successfully:', data.length, 'licenses');
            this.showNotification('Licenses loaded successfully!', 'success');
          } catch (error) {
            console.error('❌ Failed to load licenses:', error);
            // Fallback to mock data for demonstration
            this.licenses = [
              {
                id: 1,
                name: 'VMware vSphere',
                vendor: 'VMware',
                type: 'Perpetual',
                status: 'active',
                used: 8,
                total: 16,
                expiryDate: '2025-12-31'
              },
              {
                id: 2,
                name: 'Windows Server 2022',
                vendor: 'Microsoft',
                type: 'Subscription',
                status: 'expiring',
                used: 12,
                total: 20,
                expiryDate: '2025-08-15'
              },
              {
                id: 3,
                name: 'Prometheus Enterprise',
                vendor: 'Prometheus',
                type: 'Annual',
                status: 'active',
                used: 3,
                total: 10,
                expiryDate: '2026-03-20'
              }
            ];
            this.showNotification('Using sample license data', 'info');
          } finally {
            this.loading.licenses = false;
          }
        },

        // Enhanced License Management Methods
        async addLicense() {
          console.log('📝 Adding new license:', this.newLicense);
          this.loading.licenses = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/licenses`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.newLicense)
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log('✅ License added successfully:', result);
              this.showNotification('License added successfully!', 'success');
              this.showAddLicenseForm = false;
              this.resetLicenseForm();
              await this.loadLicenses(); // Reload licenses
            } else {
              throw new Error(`HTTP ${response.status}`);
            }
          } catch (error) {
            console.error('❌ Failed to add license:', error);
            this.showNotification('Failed to add license: ' + error.message, 'error');
          } finally {
            this.loading.licenses = false;
          }
        },

        async editLicense(license) {
          console.log('✏️ Editing license:', license.id);
          // Pre-populate form with license data
          this.newLicense = { ...license };
          this.showAddLicenseForm = true;
        },

        async updateLicense() {
          console.log('💾 Updating license:', this.newLicense.id);
          this.loading.licenses = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/licenses/${this.newLicense.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.newLicense)
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log('✅ License updated successfully:', result);
              this.showNotification('License updated successfully!', 'success');
              this.showAddLicenseForm = false;
              this.resetLicenseForm();
              await this.loadLicenses(); // Reload licenses
            } else {
              throw new Error(`HTTP ${response.status}`);
            }
          } catch (error) {
            console.error('❌ Failed to update license:', error);
            this.showNotification('Failed to update license: ' + error.message, 'error');
          } finally {
            this.loading.licenses = false;
          }
        },

        async deleteLicense(licenseId) {
          console.log('🗑️ Deleting license:', licenseId);
          if (!confirm('Are you sure you want to delete this license?')) {
            return;
          }
          
          this.loading.licenses = true;
          try {
            const response = await fetch(`${this.apiBaseUrl}/licenses/${licenseId}`, {
              method: 'DELETE'
            });
            
            if (response.ok) {
              const result = await response.json();
              console.log('✅ License deleted successfully:', result);
              this.showNotification('License deleted successfully!', 'success');
              await this.loadLicenses(); // Reload licenses
            } else {
              throw new Error(`HTTP ${response.status}`);
            }
          } catch (error) {
            console.error('❌ Failed to delete license:', error);
            this.showNotification('Failed to delete license: ' + error.message, 'error');
          } finally {
            this.loading.licenses = false;
          }
        },

        resetLicenseForm() {
          this.newLicense = {
            name: '',
            vendor: '',
            type: 'Perpetual',
            total: 1,
            used: 0,
            cost: 0,
            expiry_date: '',
            notes: ''
          };
        },

        cancelLicenseForm() {
          this.showAddLicenseForm = false;
          this.resetLicenseForm();
        },

        // vCenter VM Sync Method
        async syncVCenterVMs() {
          console.log('🔄 Starting vCenter VM sync...');
          this.loading.vcenterSync = true;
          
          try {
            const form = this.adminData.connectionForms.vcenter;
            
            // Enhanced credential validation
            if (!form.host || !form.username || !form.password) {
              this.showNotification('Please enter complete vCenter credentials before syncing VMs', 'error');
              return;
            }
            
            console.log('📤 Syncing VMs from vCenter:', form.host);
            
            const response = await fetch(`${this.apiBaseUrl}/admin/vcenter/sync-with-credentials`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                host: form.host,
                username: form.username,
                password: form.password
              })
            });
            
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
              console.log('✅ vCenter VM sync successful:', data);
              this.showNotification(
                `Successfully synced ${data.vm_count} VMs from vCenter (${data.underutilized_count} underutilized)`, 
                'success'
              );
              
              // Automatically refresh VM list and infrastructure data
              await this.loadUnderutilizedVMs();
              await this.loadInfrastructure();
              
              // Switch to Infrastructure tab to show results
              this.setActiveTab('infrastructure');
              
            } else {
              console.error('❌ vCenter sync failed:', data);
              this.showNotification(data.detail || 'Failed to sync VMs from vCenter', 'error');
            }
            
          } catch (error) {
            console.error('❌ vCenter sync error:', error);
            this.showNotification('Failed to sync VMs from vCenter: ' + error.message, 'error');
          } finally {
            this.loading.vcenterSync = false;
          }
        },

        // Load vCenter Infrastructure Inventory
        async loadInfrastructure() {
          this.loading.infrastructure = true;
          try {
            console.log('🏗️ Loading vCenter infrastructure inventory...');
            
            const response = await fetch(`${this.apiBaseUrl}/admin/vcenter/inventory`);
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
              this.infrastructure = data.inventory;
              console.log('✅ Infrastructure data loaded:', this.infrastructure.summary);
            } else {
              console.log('ℹ️ No infrastructure data available:', data.message);
              // Keep empty structure for UI
            }
          } catch (error) {
            console.error('❌ Failed to load infrastructure:', error);
          } finally {
            this.loading.infrastructure = false;
          }
        },

        async loadProfilePreview() {
          this.loading.profiles = true;
          try {
            console.log(`🔄 Loading profile preview (view: ${this.profileView}, cluster: ${this.selectedProfileCluster})...`);
            
            let endpoint = `${this.apiBaseUrl}/profiles/preview`;
            
            // Add cluster parameter if cluster view is selected
            if (this.profileView === 'cluster' && this.selectedProfileCluster) {
              endpoint += `?cluster=${encodeURIComponent(this.selectedProfileCluster)}`;
            }
            
            const response = await fetch(endpoint);
            if (response.ok) {
              const data = await response.json();
              
              // Transform data to ensure integer values
              if (data.system_capacity) {
                data.system_capacity.total_cpu_cores = Math.round(data.system_capacity.total_cpu_cores || 0);
                data.system_capacity.total_memory_gb = Math.round(data.system_capacity.total_memory_gb || 0);
                data.system_capacity.cpu_utilization_percent = Math.round(data.system_capacity.cpu_utilization_percent || 0);
                data.system_capacity.memory_utilization_percent = Math.round(data.system_capacity.memory_utilization_percent || 0);
              }
              
              if (data.profile_analysis && Array.isArray(data.profile_analysis)) {
                data.profile_analysis = data.profile_analysis.map(profile => ({
                  ...profile,
                  current_count: Math.round(profile.current_count || 0),
                  max_additional: Math.round(profile.max_additional || 0),
                  max_total_possible: Math.round(profile.max_total_possible || 0),
                  cpu_per_vm: Math.round(profile.cpu_per_vm || 0),
                  memory_per_vm: Math.round(profile.memory_per_vm || 0),
                  disk_per_vm: Math.round(profile.disk_per_vm || 0),
                  profile_cpu_usage_percent: Math.round(profile.profile_cpu_usage_percent || 0),
                  profile_memory_usage_percent: Math.round(profile.profile_memory_usage_percent || 0)
                }));
              }
              
              this.profilePreview = data;
              
              const clusterMsg = this.profileView === 'cluster' && this.selectedProfileCluster ? 
                ` for cluster: ${this.selectedProfileCluster}` : '';
              
              console.log('✅ Profile preview loaded successfully:', data);
              this.showNotification(`Profile preview loaded successfully${clusterMsg}`, 'success');
            } else {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
          } catch (error) {
            console.error('Error loading profile preview:', error);
            // Fallback to sample data
            this.profilePreview = {
              system_capacity: {
                total_cpu_cores: 11,
                total_memory_gb: 18.0,
                max_cpu_capacity_80_percent: 8,
                max_memory_capacity_80_percent: 14,
                current_cpu_used: 22,
                current_memory_used: 42,
                remaining_cpu: -14,
                remaining_memory: -28,
                cpu_utilization_percent: 275.0,
                memory_utilization_percent: 300.0
              },
              profile_analysis: [
                {
                  profile_id: 1,
                  profile_name: 'Small Development',
                  current_count: 3,
                  max_additional: 0,
                  max_total_possible: 3,
                  cpu_per_vm: 2,
                  memory_per_vm: 4,
                  disk_per_vm: 50,
                  license_type: 'Windows Server',
                  license_available: true,
                  license_count_available: 8,
                  limiting_factor: 'Memory',
                  profile_cpu_usage_percent: 75.0,
                  profile_memory_usage_percent: 85.7
                },
                {
                  profile_id: 2,
                  profile_name: 'Medium Production',
                  current_count: 2,
                  max_additional: 0,
                  max_total_possible: 2,
                  cpu_per_vm: 4,
                  memory_per_vm: 8,
                  disk_per_vm: 100,
                  license_type: 'VMware vSphere',
                  license_available: true,
                  license_count_available: 3,
                  limiting_factor: 'CPU',
                  profile_cpu_usage_percent: 100.0,
                  profile_memory_usage_percent: 114.3
                },
                {
                  profile_id: 4,
                  profile_name: 'Micro Service',
                  current_count: 5,
                  max_additional: 0,
                  max_total_possible: 5,
                  cpu_per_vm: 1,
                  memory_per_vm: 2,
                  disk_per_vm: 25,
                  license_type: 'Prometheus',
                  license_available: true,
                  license_count_available: 7,
                  limiting_factor: 'Memory',
                  profile_cpu_usage_percent: 62.5,
                  profile_memory_usage_percent: 71.4
                }
              ],
              total_current_vms: 12,
              total_max_additional_vms: 0
            };
            this.showNotification('Using sample profile data', 'info');
          } finally {
            this.loading.profiles = false;
          }
        },

        // Credential debugging method
        debugCredentialInput(field, event) {
          const value = event.target.value;
          console.log(`🔍 Credential Input Debug [${field}]:`);
          console.log(`   Original length: ${value.length}`);
          console.log(`   Contains special chars: ${/[!@#$%^&*(),.?":{}|<>]/.test(value)}`);
          console.log(`   Value preview: ${field === 'password' ? '*'.repeat(value.length) : value.substring(0, 20)}...`);
        },

        // Integration methods
        async testConnection(integrationType) {
          console.log(`🔧 Testing ${integrationType} connection...`);
          this.loading.connectionTest = true;
          try {
            const form = this.adminData.connectionForms[integrationType];
            
            // Enhanced credential debugging before sending
            if (integrationType === 'vcenter') {
              console.log('📤 Sending vCenter credentials:');
              console.log(`   Host: '${form.host}' (length: ${form.host ? form.host.length : 0})`);
              console.log(`   Username: '${form.username}' (length: ${form.username ? form.username.length : 0})`);
              console.log(`   Password: ${'*'.repeat(form.password ? form.password.length : 0)} (length: ${form.password ? form.password.length : 0})`);
            } else if (integrationType === 'zabbix') {
              console.log('📤 Sending Zabbix credentials:');
              console.log(`   URL: '${form.url}' (length: ${form.url ? form.url.length : 0})`);
              console.log(`   Username: '${form.username}' (length: ${form.username ? form.username.length : 0})`);
              console.log(`   Password: ${'*'.repeat(form.password ? form.password.length : 0)} (length: ${form.password ? form.password.length : 0})`);
              
              // Validate required fields before sending
              const missingFields = [];
              if (!form.url || form.url.trim() === '') missingFields.push('URL');
              if (!form.username || form.username.trim() === '') missingFields.push('Username');
              if (!form.password || form.password.trim() === '') missingFields.push('Password');
              
              if (missingFields.length > 0) {
                console.error(`❌ Missing required Zabbix fields: ${missingFields.join(', ')}`);
                this.showNotification(`Missing required connection information: ${missingFields.join(', ')}`, 'error');
                return;
              }
            }
            
            const endpoint = `${this.apiBaseUrl}/admin/${integrationType}/test`;
            
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(form)
            });
            
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
              this.showNotification(data.message, 'success');
            } else {
              this.showNotification(data.detail || 'Connection test failed', 'error');
            }
          } catch (error) {
            this.showNotification('Connection test failed: ' + error.message, 'error');
          } finally {
            this.loading.connectionTest = false;
          }
        },

        async saveIntegration(integrationType) {
          this.loading.connectionTest = true;
          try {
            const form = this.adminData.connectionForms[integrationType];
            const endpoint = `${this.apiBaseUrl}/admin/${integrationType}/save`;
            
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(form)
            });
            
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
              this.showNotification(data.message, 'success');
              // Mark as saved in UI
              this.adminData.savedIntegrations[integrationType] = {
                host: form.host,
                username: form.username,
                saved_at: new Date().toISOString()
              };
            } else {
              this.showNotification(data.detail || 'Failed to save configuration', 'error');
            }
          } catch (error) {
            this.showNotification('Failed to save configuration: ' + error.message, 'error');
          } finally {
            this.loading.connectionTest = false;
          }
        },

        async loadSavedIntegrations() {
          try {
            const response = await fetch(`${this.apiBaseUrl}/admin/integrations/config`);
            if (response.ok) {
              const data = await response.json();
              this.adminData.savedIntegrations = data.integrations || {};
              
              // Pre-populate forms with saved data
              Object.keys(data.integrations || {}).forEach(integrationType => {
                const saved = data.integrations[integrationType];
                if (this.adminData.connectionForms[integrationType]) {
                  this.adminData.connectionForms[integrationType].host = saved.host || this.adminData.connectionForms[integrationType].host;
                  this.adminData.connectionForms[integrationType].username = saved.username || this.adminData.connectionForms[integrationType].username;
                  // Don't pre-populate password for security
                }
              });
              
              console.log('Loaded saved integrations:', data.integrations);
            }
          } catch (error) {
            console.error('Failed to load saved integrations:', error);
          }
        },

        isFormValid(integrationType) {
          const form = this.adminData.connectionForms[integrationType];
          switch (integrationType) {
            case 'vcenter':
              return form.host && form.username && form.password;
            case 'zabbix':
              return form.url && form.username && form.password;
            case 'prometheus':
              return form.url; // Username/password optional for Prometheus
            default:
              return false;
          }
        },

        // Analytics Methods
        async loadClusterAnalytics() {
          this.loading.analytics = true;
          try {
            console.log('📊 Loading cluster analytics...');
            
            const response = await fetch(`${this.apiBaseUrl}/analytics/clusters`);
            const data = await response.json();
            
            if (response.ok && data.clusters) {
              this.clusterAnalytics = data.clusters;
              this.availableAnalyticsClusters = Object.keys(data.clusters);
              
              console.log(`✅ Loaded analytics for ${data.total_clusters} clusters with ${data.total_vms} VMs`);
              this.showNotification(`Loaded analytics for ${data.total_clusters} clusters`, 'success');
            } else {
              console.warn('⚠️ No cluster analytics data available:', data.message);
              this.showNotification(data.message || 'No cluster analytics data available', 'warning');
              this.clusterAnalytics = {};
            }
          } catch (error) {
            console.error('❌ Failed to load cluster analytics:', error);
            this.showNotification('Failed to load cluster analytics: ' + error.message, 'error');
            this.clusterAnalytics = {};
          } finally {
            this.loading.analytics = false;
          }
        },

        async storeHistoricalData() {
          this.loading.storing = true;
          try {
            console.log('💾 Storing current VMware data for historical tracking...');
            
            const response = await fetch(`${this.apiBaseUrl}/analytics/historical/store`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            const data = await response.json();
            
            if (response.ok && data.status === 'success') {
              console.log('✅ Historical data stored successfully:', data);
              this.showNotification(data.message, 'success');
              
              // Refresh historical data after storing
              await this.loadHistoricalAnalytics();
            } else {
              console.error('❌ Failed to store historical data:', data);
              this.showNotification(data.detail || 'Failed to store historical data', 'error');
            }
          } catch (error) {
            console.error('❌ Error storing historical data:', error);
            this.showNotification('Failed to store historical data: ' + error.message, 'error');
          } finally {
            this.loading.storing = false;
          }
        },

        async loadHistoricalAnalytics() {
          this.loading.historical = true;
          try {
            console.log(`📈 Loading historical analytics (${this.analyticsTimeRange}h, cluster: ${this.selectedAnalyticsCluster || 'all'})...`);
            
            const params = new URLSearchParams({
              hours: this.analyticsTimeRange
            });
            
            if (this.selectedAnalyticsCluster) {
              params.append('cluster', this.selectedAnalyticsCluster);
            }
            
            const response = await fetch(`${this.apiBaseUrl}/analytics/historical?${params}`);
            const data = await response.json();
            
            if (response.ok && data.historical_data) {
              this.historicalAnalytics = data.historical_data;
              this.availableAnalyticsClusters = data.available_clusters || [];
              
              console.log(`✅ Loaded ${data.total_points} historical data points`);
              this.showNotification(`Loaded ${data.total_points} historical data points`, 'success');
            } else {
              console.warn('⚠️ No historical analytics data available');
              this.showNotification('No historical analytics data available', 'warning');
              this.historicalAnalytics = [];
            }
          } catch (error) {
            console.error('❌ Failed to load historical analytics:', error);
            this.showNotification('Failed to load historical analytics: ' + error.message, 'error');
            this.historicalAnalytics = [];
          } finally {
            this.loading.historical = false;
          }
        },

        initializeCharts() {
          // Usage Chart
          const usageCtx = document.getElementById('usageChart');
          if (usageCtx) {
            new Chart(usageCtx, {
              type: 'line',
              data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                  label: 'CPU Usage',
                  data: [65, 59, 80, 81, 56, 55],
                  borderColor: 'rgb(59, 130, 246)',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  tension: 0.4
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                }
              }
            });
          }

          // Distribution Chart
          const distCtx = document.getElementById('distributionChart');
          if (distCtx) {
            new Chart(distCtx, {
              type: 'doughnut',
              data: {
                labels: ['Production', 'Development', 'Testing'],
                datasets: [{
                  data: [60, 25, 15],
                  backgroundColor: [
                    'rgb(59, 130, 246)',
                    'rgb(16, 185, 129)',
                    'rgb(245, 158, 11)'
                  ]
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false
              }
            });
          }
        }
      },
      async mounted() {
        try {
          // Initialize Lucide icons first
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          
          // Sequence async operations to prevent race conditions
          await this.checkApiConnection();
          
          // Load system information for dynamic OS detection
          await this.loadSystemInfo();
          
          // Load saved integration configurations
          await this.loadSavedIntegrations();
          
          // Load VMs after system info is available
          await this.loadUnderutilizedVMs();
          
          // Initialize charts after DOM is stable
          this.$nextTick(() => {
            setTimeout(() => {
              this.initializeCharts();
              // Re-initialize icons after DOM updates
              if (typeof lucide !== 'undefined') {
                lucide.createIcons();
              }
            }, 200);
          });

          // Get initial system stats (non-blocking)
          this.getMacStats().catch(err => {
            console.warn('Failed to load Mac stats:', err);
          });
          
          // Set up periodic endpoint status checking
          await this.checkAllEndpoints();
          setInterval(() => {
            this.checkAllEndpoints().catch(err => {
              console.warn('Endpoint status check failed:', err);
            });
          }, 30000);
          
        } catch (error) {
          console.error('Error during component mounting:', error);
          this.showNotification('Failed to initialize dashboard', 'error');
        }
      },
      
      watch: {
        // Re-initialize icons when active tab changes
        activeTab() {
          this.$nextTick(() => {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
          });
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
